/**
 * @preserve
 * 
 * 
 *
 *
 *
 *
 *                             . MMMMMMM  .
 *                           .MM          MM
 *                          M MMM ..MMMMM .  M.
 *                         M.M     .     MM   M ..
 *                       .MM8   .M MMM    .M   MM
 *     MMM               .MM.   O MMM M    M.  M  .MMMM. MM.
 *    .MM.MM.            .M.M  . 7MMM     M.  .M  MMMM.. .
 *   ..M=MM MM.           M  NM       . MM   .MM
 *   .MMMMMNMMMM.          M   .MMMMMM=    MM
 *   .    MMMMMMM.          .MM.       . MM=.
 *   .MMMMMMM.MMMM           . MMMMMMM... .
 *   .MNMMMMMM?.MMMMMMMMMMMMMMM. MM
 *        MMMMM  MM                  M.
 *           .MMM                    .M
 *            . M.                     ,
 *               MM                  .M
 *                .M                  O
 *                 M              ..MM
 *                  .ZMMMMMMMMMMMMM
 *                      M  M.
 *                     M    M
 *                     M    M..
 *                    M.     M .
 *                   MMMM    MMMMM
 *                  .M M,  .M .M
 *                  M..M    .
 *                 .M.
 *                  .
 *
 *
 *
 *                                         ,,sNNNppp,
 *                                     ,s#b9^,        "8@p,
 *                                   ;#bp##WWTT*8W###p,   "8#p
 *                                 .#b#b`     .,,     7@#,   @Q
 *                                ,Gyb     ;#bQQQ@N,     @b   @"Wp,
 *       "8#p                     8^G,    8, 8##b sb     jb   @b  *TT8Gqpppsssp
 *       7Np|8@p                  @ '@p    `'*GTTT`    ,#"   ,#,,,.G#WT*||^
 *      {#QQ7WQQ7Sp               *Q   7Wp,         :#b    ,##|^`
 *      ^79@###Q@#Q@N              '@N,   ^"^^7"""^      y#b`
 *      .,,;,j|7@####9N               "TNp,       .:;sS#b"
 *      8######bGG8@###Q,               ,|```j#` `
 *      *TGG8@#QGGGVGQ28#bTT9"^^^^^^^^**`   %bWo
 *            ^7@W#Qp, ^                          :
 *                 *@#b                            |
 *                   '@Q                           ;
 *                     7@p                        ,^
 *                      '@N                      :^
 *                        "sssp,,,,;ppoo;:.,:ssG^
 *                             `,` '@b
 *                             #b   jb
 *                            @D    '@p
 *                          .#b      ?@p
 *                          @#@N,     @##8#Np
 *                         ,#7@^7~   @b 8N
 *                         #b ^9     ^
 *                        @b
 *
 *
 *
 *
 *
 *
 *
 *
 *                           :=======-=-
 *                        .+**====+=--..=++.
 *                       -**=.  .:: ..=*- :%:
 *     =-               :%*   ++#%#*-   +- -#+=-:.
 *     +***-            +:*:  ==##==.  -+. =+.:=*#*+===.
 *    =@#%*#*+.         :* :==:  ...-==. :++=:.
 *    .-+#@@@@@*.        .+=. .----:   :#+.
 *    *@%%#*%@@@@-          -#=-*=====-.
 *    :*#@@@@%*#@@+=-=----=-=  -*=:
 *         :=#@+..                 +:
 *            .*%.                  *
 *              :*=                :=
 *                *=             .==
 *                 :===*=+%===-==:
 *                    +=  %
 *                   ==   ++
 *                  =@-    @#+-.
 *                  %#**  :#++:-
 *                 += =   :  .
 *                 +
 *
 *
 *
 *
 *
 *                                             &@@@@.....(@@@@@
 *                                         @@%  /@@@@@@*        %@@@
 *                                       @% @@,          ,( @@@    ,@@
 *                                     &@.@*      &@@@@@&      ,@@   &@@,
 *        &@@                         (@@*     *@. @@@@, @@      @    @, @@@@.
 *        #  @@@                      @, @%     @@@,..@@@      ,@*    @.     .&@@@@@&&
 *       @@**@@, @@#                  #@   @@               #@/     (@@@@(
 *       @@@@@@@@@@ @@/                 @#     @@@.@@@@@@@.      @@@
 *            @@@@@@@@@@@                 %@%                 (@@/
 *      %@@@@@@@@@@ @@@@@@#                   @@@@@@@@@@@@@
 *       (((@@@@@@@@@. (@@@@@@@@@@@@@@@@@@@@@@   ,@@/
 *             @@@@@@@   @@(                           @%
 *                   @@@@                                @
 *                      @@                                &
 *                        @@                             @
 *                          @,                          @
 *                           @                       @@.
 *                                ,,*@, @@
 *                                 @@    @
 *                                @@     @@
 *                               @&       @@
 *                              @@@        @@@@@#
 *                             @@@/&@@    @@ @@
 *                            @@  @@     &@   *
 *                            @
 *
 *
 *
 *
 *                                                                            .|8@$$@@@$@$$@@@$|)
 *                                                                        ^8@@@@$W#I        (##$8@$@$$,
 *                                                                     c@@@@J'   .                 :W@$@h[
 *                                                                   #$$@_   "(c*@@$@c0vc              #$$@$@v
 *                                                                 p@@v "_@@@@@@@8wwwO8@$@@@$@@@@f         w$@$W
 *                                                               )$@p -@@$$i             .'M$@@@$$$%         $$B*
 *                                                              Z@@^l@@@!                         u@@@W'       $@&
 *                                                             &@* k@@            }((@$&(            #$@$i     .@$@1
 *                                                            $$#^@@0          @$@$@###M@@$$           L@$J     c@$$$$"
 *             kQ                                            t@@$@@`         b@$u  @@@@$I^$$$`          *@@      $@ m@@$o
 *           ^#@@@@(                                         @@>@@          $@Z  X$$$@$@@  -@@@         0@@      $@b   U@@$@@bv}'
 *             m@@$@@p                                       @@ d@W        d@+,  @$$$@@v  .@$*          #@a      $$a        Oo@@$@$@$@$@$@@$$$$@$
 *           `k   L$@$$B,                                    @&  L@B        j$@$%M-^I |%@$$$"         +@$@       @@/           #@@$@$@$$@$@$"``'.
 *           )@@@@Q  [@$@$0                                  @8   @@@(         l}x@@@@@k}           ;&@@        a$B    QOa@@@@@$B}
 *          v$${ Q@@@b^ _$@@B!                               @$'    O@@@                          j@@$         @$@@@@$@$0'                              
 *          c$@$B@{iB$@@@, f$$$_                             n$$      ?@$$J                    Y$@$M         %@@8M)                                     
 *          @@@$$@@@@d @@@$@ :$$@z                            $$$?       #@@@@)            bo@$@>         O@@$$i                                        
 *          m$@@@$@$$$@@@B@@$@%]@@@L                           .$@@l         r$@@B@@@$@@@@@$I           $@@@$n                                          
 *               p$$$@$@@$@$@@$$@a@$$a                           ,@@$/                                 h$$$"                                            
 *           .   .   {@@@@$@$$$$$$@$$$@I                           .$@@$U                          c@@$@d.                                              
 *          U$$$$$$@LL"    Q@$@$$$$@$x@$J                              *$$$@b'        jJU>LLL@@@@@@@M{                                                  
 *         h$$$$$$$@@@@$@@$$B1Q$$$$@$@@$@,                               .@$@$@$@@$@$@$@$@@&CJJ.                                                        
 *          @$@@$$$$$$$$$8"#W$@@@@@@@$$$$@@                             |@@~      @$%
 *           <<@$$$$$$$$$@@$@@8d  ip@@$$$$$$8%8@$$$$@$$$$$@$$$$$$$$@$px@$]     .&$$l
 *          m@$$$@@@$$$$$$$$@BJ@@@@@$mJ@@$$$dxxxxxi                'x)fn       W@$@@@@%|
 *                 >p@$@$$@@$$$$@"  wd@@@$*                                           'O@&_
 *                      't$$$$$@$@$8     "'                                              -B&'
 *                           "b$@$$@@@                                                     @$.
 *                              ,#$@@@$$                                                   'BW
 *                                .w$$%B)                                                   ]@~
 *                                  `M$$W                                                    @C
 *                                    [@@@-                                                 8@+
 *                                      @$$@                                                @@
 *                                       W$@@                                              @$/
 *                                         B$B                                            %B]
 *                                          $@$                                          @8+
 *                                          r$@M                                      ^@@%
 *                                           '$$@Mpm'             ppmw            da@$@p'
 *                                             `uwa@@@@@$$$@$$$@$@@@@@@@@@@@$$$$$@@ul
 *                                                       ,@8    $$@
 *                                                       @$]    ,@@-
 *                                                     }@@I      @@]
 *                                                     @$/       C$@
 *                                                    $@I         $$p
 *                                                   @$w          $@@'
 *                                                  w$@           '@$$
 *                                                 $@$: .          O@@Z
 *                                                Q$$BU             $$$$$$#
 *                                               '$$$$$@L           $$$$d@@@@@@Y+
 *                                               J$$@@@$@@#        ]@@M$$r  10@@@*
 *                                               $@pa$$ a$@@       @@$  @@%
 *                                              JB@  @@Q          @@@^   $@@
 *                                             ,$@w  l$@r         %$f     r.
 *                                             $@W     k
 *                                            v@$h
 *                                            o@J
 *                                            B$_
 *
 * 
 * 
 *
 *                                .::::.
 *                            .:::..     .:::.
 *                          .:::::...---::.  :=
 *                         :::    ...:.   :-:  +:
 *      ::                ::-   .. %%:.:    =  :..::::.. ...
 *     ..::-:             - ::   ..:...   .:   =.: :::::..
 *     +++=--::            :  ....    . ..   --..
 *      .-*##%*+=           ::.    .      .:-.
 *     ==+=-:=*%*+:            :.:.:.......
 *     -==+*+-:-=+*=:.::::::....  ::
 *         .--=-:..                   .
 *             .-=                     :
 *               .=.                   :
 *                 -:                 .
 *                  :::.   ...........
 *                      .:  =
 *                      -   =
 *                     -     +
 *                    *-:    =*--:
 *                   :-=::   + -
 *                   +  .
 *                  :.
 *                  
 *                  
 *
 *
 *                      :=***+*+=.
 *                    +@@%#***++=+#*.
 *                  .%@*:.=**+::*#-=@=.
 *    %@*:          *@* .@%@@@#  #* @++##*++++
 *   :@@@@%=        **+#=-:==-:+#-:*@*+==:.
 *   :#%@@@@@+       +#=-=++++::-#%-
 *   +@@@@@@@@%-..:::::=@*#%++++-.
 *   .+*#@@@@%@*=--::--=. =+::
 *        .-#@=              :*
 *           :%*             -#
 *             #*.   .... .:+#
 *              -=+@*#%====-.
 *                #+ -@.
 *               *%   #%=:
 *              :@@%: %%@++
 *              %==:  = :
 *              =
 *
 * y
 *
 *
 *
 *                                             :-----:::::...::
 *                                         .:-.   ..          .:--:
 *                                        -: ----::..:==-+--:     .*-
 *                                      :: -:                --:    :+
 *                                     -.::      .:::::-.      .+.   -+-.
 *        .:.                         .:-      .:. +%%+ :-      .+    + :---:
 *         .:-:                       = .:     ::  ++: .:.      -.    +      ::-==----:-.
 *        ::: .--:                    =  .:.      .:::.       ::     =..:: ::::.
 *       ==-:---:.::.                  -    ::.            ::.     :=::.
 *       :=+#%*=-=+:-+:                 -.     ::. :::::.       .-*:
 *          .-=*%@#%#--+.                .::.                 .:-:
 *       ==-::::..-=*##+-:                  ...:::::::::::::::
 *       -=**++==-:::=*#@*-.                 ..    :
 *       .:::==++-=::::::=++-:::::......::: .    .-::
 *            .::==+-:. .:.
 *                  :===:                                .
 *                     -=.                               .
 *                       #-                              :
 *                        .=                            ..
 *                          +.                          .
 *                           =                       ..
 *                            ::::::::::+::::.: ..::.
 *                                  :   .=
 *                                .=     *
 *                                =      =:
 *                               =        #.
 *                              *-        :%--.
 *                             -*-=+.     -+=.:---
 *                             * :: -     *  -:
 *                            +:  -      .
 *                           .+
 *                           :
 *
 * 
 * 
 *
 *                                     .,,,;;,'''..
 *                                 .'','...     ..',,,.
 *                               .,,,,,,',,',;;:;,.  .,l,
 *                              .,',.     ...     ,;,   :l.
 *                             ':;.    .'.:do;;.    .c   ol;'.
 *      ';;'                   ;.;    ', .dkl';,    .c   :; .'.',::,,'''.
 *     ',,;;;,.                ; .,'     .'''.    .'.   .d;''.''''.
 *    .oxddl;::,,.             ',  .'''.   .... .'.   ,:;..
 *     .'cOX0OOkdoc.            .,'.   .. .....     'lc.
 *    .:;,,::co0XOko'              ....''..'.'''''''.
 *    .dxk0KKdc:cdOXKl............. .. ..,c....
 *     .',lxOOxl:'':xkl,',......'....    ,'.
 *          .';:oo:...                        .
 *               .cd,    ╔═╗┌─┐┬─┐┬  ┬┌─┐┬─┐   .
 *                 .l;   ╚═╗├┤ ├┬┘└┐┌┘├┤ ├┬┘   '
 *                   'l. ╚═╝└─┘┴└─ └┘ └─┘┴└─  '.
 *                    .o.                   ...
 *                     .''''','.;:''.........
 *                          .'  .l
 *                         .:.   l'
 *                        .:.    .l.
 *                       .x:      :k;,.
 *                       cxlc;    cdc,,;;.
 *                      'l :..   .c  ,
 *                      o.
 *                     .,
 *
 *             ╦ ╦┬ ┬┌┐ ┬─┐┬┌┬┐  ╔═╗┌┐  ┬┌─┐┌─┐┌┬┐┌─┐
 *             ╠═╣└┬┘├┴┐├┬┘│ ││  ║ ║├┴┐ │├┤ │   │ └─┐
 *             ╩ ╩ ┴ └─┘┴└─┴─┴┘  ╚═╝└─┘└┘└─┘└─┘ ┴ └─┘
 *
 * Created by Valentin on 10/22/14.
 *
 * Copyright (c) 2015 Valentin Heun
 *
 * All ascii characters above must be included in any redistribution.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */

class Utilities {
    /**
     * Utilities
     * @param {object} dependencies
     * @param {object} dependencies.fs
     * @param {object} dependencies.xml2js
     * @param {object} dependencies.ip
     * @param {object} dependencies.ObjectModel
     * @param {object} dependencies.path
     * @param {object} dependencies.knownObjects
     * @param {object} dependencies.nodeFetch
     * @param {object} dependencies.os
     * @param {object} dependencies.dgram
     * @param {object} dependencies.request
     * @param {object} dependencies.root const root = require('../getAppRootFolder');
     **/
    constructor(dependencies) {
        // node Modules
        this.fs = dependencies.fs;
        this.xml2js = dependencies.xml2js;
        this.ip = dependencies.ip;
        this.path = dependencies.path;
        this.knownObjects = dependencies.knownObjects;
        this.fetch = dependencies.nodeFetch;
        this.os = dependencies.os;
        this.dgram = dependencies.dgram;
        this.request = dependencies.request;

        // project
        this.ObjectModel = dependencies.ObjectModel;
        this.root = dependencies.root;


        this.identityFolderName = '.identity'; // TODO: get this from server.js
        this.writeBufferList = {};
        this.isWriting = false;

        this.crcTable = [0x00000000, 0x77073096, 0xEE0E612C, 0x990951BA,
            0x076DC419, 0x706AF48F, 0xE963A535, 0x9E6495A3,
            0x0EDB8832, 0x79DCB8A4, 0xE0D5E91E, 0x97D2D988,
            0x09B64C2B, 0x7EB17CBD, 0xE7B82D07, 0x90BF1D91,
            0x1DB71064, 0x6AB020F2, 0xF3B97148, 0x84BE41DE,
            0x1ADAD47D, 0x6DDDE4EB, 0xF4D4B551, 0x83D385C7,
            0x136C9856, 0x646BA8C0, 0xFD62F97A, 0x8A65C9EC,
            0x14015C4F, 0x63066CD9, 0xFA0F3D63, 0x8D080DF5,
            0x3B6E20C8, 0x4C69105E, 0xD56041E4, 0xA2677172,
            0x3C03E4D1, 0x4B04D447, 0xD20D85FD, 0xA50AB56B,
            0x35B5A8FA, 0x42B2986C, 0xDBBBC9D6, 0xACBCF940,
            0x32D86CE3, 0x45DF5C75, 0xDCD60DCF, 0xABD13D59,
            0x26D930AC, 0x51DE003A, 0xC8D75180, 0xBFD06116,
            0x21B4F4B5, 0x56B3C423, 0xCFBA9599, 0xB8BDA50F,
            0x2802B89E, 0x5F058808, 0xC60CD9B2, 0xB10BE924,
            0x2F6F7C87, 0x58684C11, 0xC1611DAB, 0xB6662D3D,
            0x76DC4190, 0x01DB7106, 0x98D220BC, 0xEFD5102A,
            0x71B18589, 0x06B6B51F, 0x9FBFE4A5, 0xE8B8D433,
            0x7807C9A2, 0x0F00F934, 0x9609A88E, 0xE10E9818,
            0x7F6A0DBB, 0x086D3D2D, 0x91646C97, 0xE6635C01,
            0x6B6B51F4, 0x1C6C6162, 0x856530D8, 0xF262004E,
            0x6C0695ED, 0x1B01A57B, 0x8208F4C1, 0xF50FC457,
            0x65B0D9C6, 0x12B7E950, 0x8BBEB8EA, 0xFCB9887C,
            0x62DD1DDF, 0x15DA2D49, 0x8CD37CF3, 0xFBD44C65,
            0x4DB26158, 0x3AB551CE, 0xA3BC0074, 0xD4BB30E2,
            0x4ADFA541, 0x3DD895D7, 0xA4D1C46D, 0xD3D6F4FB,
            0x4369E96A, 0x346ED9FC, 0xAD678846, 0xDA60B8D0,
            0x44042D73, 0x33031DE5, 0xAA0A4C5F, 0xDD0D7CC9,
            0x5005713C, 0x270241AA, 0xBE0B1010, 0xC90C2086,
            0x5768B525, 0x206F85B3, 0xB966D409, 0xCE61E49F,
            0x5EDEF90E, 0x29D9C998, 0xB0D09822, 0xC7D7A8B4,
            0x59B33D17, 0x2EB40D81, 0xB7BD5C3B, 0xC0BA6CAD,
            0xEDB88320, 0x9ABFB3B6, 0x03B6E20C, 0x74B1D29A,
            0xEAD54739, 0x9DD277AF, 0x04DB2615, 0x73DC1683,
            0xE3630B12, 0x94643B84, 0x0D6D6A3E, 0x7A6A5AA8,
            0xE40ECF0B, 0x9309FF9D, 0x0A00AE27, 0x7D079EB1,
            0xF00F9344, 0x8708A3D2, 0x1E01F268, 0x6906C2FE,
            0xF762575D, 0x806567CB, 0x196C3671, 0x6E6B06E7,
            0xFED41B76, 0x89D32BE0, 0x10DA7A5A, 0x67DD4ACC,
            0xF9B9DF6F, 0x8EBEEFF9, 0x17B7BE43, 0x60B08ED5,
            0xD6D6A3E8, 0xA1D1937E, 0x38D8C2C4, 0x4FDFF252,
            0xD1BB67F1, 0xA6BC5767, 0x3FB506DD, 0x48B2364B,
            0xD80D2BDA, 0xAF0A1B4C, 0x36034AF6, 0x41047A60,
            0xDF60EFC3, 0xA867DF55, 0x316E8EEF, 0x4669BE79,
            0xCB61B38C, 0xBC66831A, 0x256FD2A0, 0x5268E236,
            0xCC0C7795, 0xBB0B4703, 0x220216B9, 0x5505262F,
            0xC5BA3BBE, 0xB2BD0B28, 0x2BB45A92, 0x5CB36A04,
            0xC2D7FFA7, 0xB5D0CF31, 0x2CD99E8B, 0x5BDEAE1D,
            0x9B64C2B0, 0xEC63F226, 0x756AA39C, 0x026D930A,
            0x9C0906A9, 0xEB0E363F, 0x72076785, 0x05005713,
            0x95BF4A82, 0xE2B87A14, 0x7BB12BAE, 0x0CB61B38,
            0x92D28E9B, 0xE5D5BE0D, 0x7CDCEFB7, 0x0BDBDF21,
            0x86D3D2D4, 0xF1D4E242, 0x68DDB3F8, 0x1FDA836E,
            0x81BE16CD, 0xF6B9265B, 0x6FB077E1, 0x18B74777,
            0x88085AE6, 0xFF0F6A70, 0x66063BCA, 0x11010B5C,
            0x8F659EFF, 0xF862AE69, 0x616BFFD3, 0x166CCF45,
            0xA00AE278, 0xD70DD2EE, 0x4E048354, 0x3903B3C2,
            0xA7672661, 0xD06016F7, 0x4969474D, 0x3E6E77DB,
            0xAED16A4A, 0xD9D65ADC, 0x40DF0B66, 0x37D83BF0,
            0xA9BCAE53, 0xDEBB9EC5, 0x47B2CF7F, 0x30B5FFE9,
            0xBDBDF21C, 0xCABAC28A, 0x53B39330, 0x24B4A3A6,
            0xBAD03605, 0xCDD70693, 0x54DE5729, 0x23D967BF,
            0xB3667A2E, 0xC4614AB8, 0x5D681B02, 0x2A6F2B94,
            0xB40BBE37, 0xC30C8EA1, 0x5A05DF1B, 0x2D02EF8D];

        this.crc = 0xffffffff;

        this.homedir = this.path.join(this.os.homedir(), 'Documents', 'spatialToolbox');
        this.oldHomeDirectory = this.path.join(this.os.homedir(), 'Documents', 'realityobjects');

        // Default back to old realityObjects dir if it exists
        if (!this.fs.existsSync(this.homedir) &&
            this.fs.existsSync(this.oldHomeDirectory)) {
            this.homedir = this.oldHomeDirectory;
        }

        if (process.env.NODE_ENV === 'test' || this.os.platform() === 'android' || !this.fs.existsSync(this.path.join(this.os.homedir(), 'Documents'))) {
            this.homedir = this.path.join(this.root, 'spatialToolbox');
        }

        this.hardwareIdentity = this.homedir + '/' + this.identityFolderName;

        this.hardwareInterfaces = {};
    }

    // todo memory
    writeObject(objectLookup, folder, id) {
        objectLookup[folder] = {id: id};
    }
    // todo memory
    readObject(objectLookup, folder) {
        if (objectLookup.hasOwnProperty(folder)) {
            return objectLookup[folder].id;
        } else {
            return null;
        }
    }
    // todo file
    createFolder(folderVar, objectsPath, debug) {
        let folder = objectsPath + '/' + folderVar + '/';
        let identity = objectsPath + '/' + folderVar + '/' + this.identityFolderName + '/';
        if (debug) console.log('Creating folder: ' + folder);

        if (!this.fs.existsSync(folder)) {
            this.fs.mkdirSync(folder, '0766', function (err) {
                if (err) {
                    console.error(err);
                }
            });
        }

        if (!this.fs.existsSync(identity)) {
            this.fs.mkdirSync(identity, '0766', function (err) {
                if (err) {
                    console.error(err);
                }
            });
        }
    }
// todo file
    createFrameFolder(folderVar, frameVar, dirnameO, objectsPath, debug, location) {
        if (location === 'global') return;
        let folder = objectsPath + '/' + folderVar + '/';
        let identity = folder + this.identityFolderName + '/';
        let firstFrame = folder + frameVar + '/';
        if (debug) console.log('Creating application (frame) folder: ' + folder);

        if (!this.fs.existsSync(folder)) {
            this.fs.mkdirSync(folder, '0766', function (err) {
                if (err) {
                    console.error(err);
                }
            });
        }

        if (!this.fs.existsSync(identity)) {
            this.fs.mkdirSync(identity, '0766', function (err) {
                if (err) {
                    console.error(err);
                }
            });
        }

        if (!this.fs.existsSync(firstFrame)) {
            this.fs.mkdirSync(firstFrame, '0766', function (err) {
                if (err) {
                    console.error(err);
                }
            });

            try {
                this.fs.createReadStream(dirnameO + '/libraries/objectDefaultFiles/index.html').pipe(this.fs.createWriteStream(objectsPath + '/' + folderVar + '/' + frameVar + '/index.html'));
                this.fs.createReadStream(dirnameO + '/libraries/objectDefaultFiles/bird.png').pipe(this.fs.createWriteStream(objectsPath + '/' + folderVar + '/' + frameVar + '/bird.png'));
            } catch (e) {
                if (debug) console.error('Could not copy source files', e);
            }
        }
    }

    /**
     * Recursively delete a folder and its contents
     * @param {string} folder - path to folder
     */
    // todo file
    deleteFolderRecursive(folder) {
        if (this.fs.existsSync(folder)) {
            this.fs.readdirSync(folder).forEach(function (file) {
                let curPath = folder + '/' + file;
                if (this.fs.lstatSync(curPath).isDirectory()) { // recurse
                    this.deleteFolderRecursive(curPath);
                } else { // delete file
                    this.fs.unlinkSync(curPath);
                }
            });
            this.fs.rmdirSync(folder);
        }
    }

    /**
     * Deletes a directory from the hierarchy. Intentionally limited to frames so that you don't delete something more important.
     * @param objectKey
     * @param frameKey
     * @param dirname0
     */
    // todo file
    deleteFrameFolder(objectName, frameName, objectsPath) {
        console.log('objectName', objectName);
        console.log('frameName', frameName);

        let folderPath = objectsPath + '/' + objectName + '/' + frameName;
        console.log('delete frame folder', folderPath);

        let acceptableFrameNames = ['gauge', 'decimal', 'graph', 'light']; // TODO: remove this restriction
        let isDeletableFrame = false;
        acceptableFrameNames.forEach(function (nameOption) {
            if (frameName.indexOf(nameOption) > -1) {
                isDeletableFrame = true;
                console.log('it is a ' + nameOption + ' frame');
            }
        });

        if (isDeletableFrame) {
            this.deleteFolderRecursive(folderPath);
        }
    }

    /**
     * Generates a random number between the two inputs, inclusive.
     * @param {number} min - The minimum possible value.
     * @param {number} max - The maximum possible value.
     */
    // todo utility
    randomIntInc(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
    }

    /**
     * Generates a 12-digit unique identifier string, much of which is based on the current time.
     */
    // todo utility
    uuidTime() {
        let dateUuidTime = new Date();
        let abcUuidTime = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let stampUuidTime = parseInt(Math.floor((Math.random() * 199) + 1) + '' + dateUuidTime.getTime()).toString(36);
        while (stampUuidTime.length < 11) stampUuidTime = abcUuidTime.charAt(Math.floor(Math.random() * abcUuidTime.length)) + stampUuidTime;
        return '_' + stampUuidTime;
    }

    /**
     * Create a data flow processing Engine
     * @param {string} folderName
     * @param {string} objectsPath
     * @param {object} dependencies.xml2js
     **/
    // todo file
    getObjectIdFromTargetOrObjectFile(folderName, objectsPath) {

        if (folderName === 'allTargetsPlaceholder') {
            return 'allTargetsPlaceholder000000000000';
        }

        let xmlFile = objectsPath + '/' + folderName + '/' + this.identityFolderName + '/target/target.xml';
        let jsonFile = objectsPath + '/' + folderName + '/' + this.identityFolderName + '/object.json';

        if (this.fs.existsSync(xmlFile)) {
            let resultXML = '';
            this.xml2js.Parser().parseString(this.fs.readFileSync(xmlFile, 'utf8'),
                function (err, result) {
                    for (let first in result) {
                        for (let secondFirst in result[first].Tracking[0]) {
                            resultXML = result[first].Tracking[0][secondFirst][0].$.name;
                            if (typeof resultXML === 'string' && resultXML.length === 0) {
                                console.warn('Target file for ' + folderName + ' has empty name, ' +
                                    'and may not function correctly. Delete and re-upload target for best results.');
                                resultXML = null;
                            }
                            break;
                        }
                        break;
                    }
                });

            return resultXML;
        } else if (this.fs.existsSync(jsonFile)) {
            try {
                let thisObject = JSON.parse(this.fs.readFileSync(jsonFile, 'utf8'));
                if (thisObject.hasOwnProperty('objectId')) {
                    return thisObject.objectId;
                } else {
                    return null;
                }
            } catch (e) {
                console.log('error reading json file', e);
            }
        } else {
            return null;
        }
    }
    // todo file
    getAnchorIdFromObjectFile(folderName, objectsPath) {

        if (folderName === 'allTargetsPlaceholder') {
            return 'allTargetsPlaceholder000000000000';
        }

        let jsonFile = objectsPath + '/' + folderName + '/object.json';

        if (this.fs.existsSync(jsonFile)) {
            let thisObject = JSON.parse(this.fs.readFileSync(jsonFile, 'utf8'));
            if (thisObject.hasOwnProperty('objectId')) {
                return thisObject.objectId;
            } else {
                return null;
            }
        } else {
            return null;
        }
    };

    /**
     *
     * @param folderName
     * @param objectsPath
     * @return {string}
     */
    // todo file
    getTargetSizeFromTarget(folderName, objectsPath) {
        if (folderName === 'allTargetsPlaceholder') {
            return 'allTargetsPlaceholder000000000000';
        }

        let xmlFile = objectsPath + '/' + folderName + '/' + this.identityFolderName + '/target/target.xml';
        let resultXML = {
            width: 0.3, // default width and height so it doesn't crash if there isn't a size in the xml
            height: 0.3
        };

        if (this.fs.existsSync(xmlFile)) {
            try {
                this.xml2js.Parser().parseString(this.fs.readFileSync(xmlFile, 'utf8'), function (err, result) {
                    let first = Object.keys(result)[0];
                    let secondFirst = Object.keys(result[first].Tracking[0])[0];
                    let sizeString = result[first].Tracking[0][secondFirst][0].$.size;
                    let sizeFloatArray = sizeString.split(' ').map(function (elt) {
                        // TODO: this assumption makes it backwards compatible but might cause problems in the future
                        return (parseFloat(elt) < 10) ? parseFloat(elt) : 0.001 * parseFloat(elt); // detect meter or mm scale
                    });
                    resultXML = {
                        width: sizeFloatArray[0],
                        height: sizeFloatArray[1]
                    };
                });
            } catch (e) {
                console.warn('error parsing xml, returning default size');
            }
        }
        return resultXML;
    }

    /**
     * Saves the RealityObject as "object.json"
     * (Writes the object state to permanent storage)
     * @param {object}   objects - The array of objects
     * @param {string}   object    - The key used to look up the object in the objects array
     * @param {string}   objectsPath  - The base directory name in which an "objects" directory resides.
     * @param {boolean}   writeToFile  - Give permission to write to file.
     **/
    // todo file
    writeObjectToFile(objects, object, objectsPath, writeToFile) {
        if (writeToFile) {
            this.writeBufferList[object] = objectsPath;
        }
        // trigger write process
        this.executeWrite(objects);
    };
    // todo file
    executeWrite(objects) {
        // console.log('execute write');
        // if write Buffer is empty, stop.
        if (Object.keys(this.writeBufferList).length === 0) return;

        if (this.isWriting) {
            // come back later;
            setTimeout(function () {
                this.executeWrite(objects);
            }, 20);
            return;
        }
        // block function from re-execution
        this.isWriting = true;

        // copy the first item and delete it from the buffer list
        let firstKey = Object.keys(this.writeBufferList)[0];
        let objectsPath = this.writeBufferList[firstKey];
        let obj = firstKey;
        delete this.writeBufferList[firstKey];

        // prepare to write
        let outputFilename = objectsPath + '/' + objects[obj].name + '/' + this.identityFolderName + '/object.json';
        let objectData = objects[obj];
        console.log('writing:', obj);
        // write file
        this.fs.writeFile(outputFilename, JSON.stringify(objectData, null, '\t'), function (err) {
            // once writeFile is done, unblock writing and loop again
            this.isWriting = false;
            this.executeWrite(objects);

            if (err) {
                console.error(err);
            }
        });
    }

    // todo utility
    crc32(data) {
        for (let i = 0, l = data.length; i < l; i++) {
            this.crc = this.crc >>> 8 ^ this.crcTable[this.crc & 255 ^ data[i]];
        }
        return (this.crc ^ -1) >>> 0;
    }
    // todo utility
    crc16reset() {
        this.crc = 0xffffffff;
    }
    // todo utility
    itob62(i) {
        let u = i;
        let b32 = '';
        do {
            let d = Math.floor(u % 62);
            if (d < 10) {
                b32 = String.fromCharCode('0'.charCodeAt(0) + d) + b32;
            } else if (d < 36) {
                b32 = String.fromCharCode('a'.charCodeAt(0) + d - 10) + b32;
            } else {
                b32 = String.fromCharCode('A'.charCodeAt(0) + d - 36) + b32;
            }
            u = Math.floor(u / 62);
        } while (u > 0);
        return b32;
    }

    /**
     * Generates a checksum of all files hand over with fileArray
     * @param objects hand over the overall object list
     * @param fileArray The array that represents all files that should be checksumed
     * @return {string} checksum text
     */
    // todo utility
    generateChecksums(objects, fileArray) {
        this.crc16reset();
        let checksumText;
        for (let i = 0; i < fileArray.length; i++) {
            if (this.fs.existsSync(fileArray[i])) {
                checksumText = this.itob62(this.crc32(this.fs.readFileSync(fileArray[i])));
            }
        }
        console.log('created Checksum', checksumText);
        return checksumText;
    };

    // todo file
    updateObject(objectName, objects) {
        console.log('update ', objectName);

        let objectFolderList = this.fs.readdirSync(this.homedir).filter(function (file) {
            return this.fs.statSync(this.homedir + '/' + file).isDirectory();
        });

        try {
            while (objectFolderList[0][0] === '.') {
                objectFolderList.splice(0, 1);
            }
        } catch (e) {
            console.log('no hidden files');
        }


        for (let i = 0; i < objectFolderList.length; i++) {
            if (objectFolderList[i] === objectName) {
                let tempFolderName = this.getObjectIdFromTargetOrObjectFile(objectFolderList[i], this.homedir);
                console.log('TempFolderName: ' + tempFolderName);

                if (tempFolderName !== null) {
                    // fill objects with objects named by the folders in objects

                    objects[tempFolderName].name = objectFolderList[i];

                    // try to read a saved previous state of the object
                    try {
                        objects[tempFolderName] = JSON.parse(this.fs.readFileSync(this.homedir + '/' + objectFolderList[i] + '/' + this.identityFolderName + '/object.json', 'utf8'));
                        objects[tempFolderName].ip = this.ip.address();

                        // this is for transforming old lists to new lists
                        if (typeof objects[tempFolderName].objectValues !== 'undefined') {
                            objects[tempFolderName].frames[tempFolderName].nodes = objects[tempFolderName].objectValues;
                            delete objects[tempFolderName].objectValues;
                        }
                        if (typeof objects[tempFolderName].objectLinks !== 'undefined') {
                            objects[tempFolderName].frames[tempFolderName].links = objects[tempFolderName].objectLinks;
                            delete objects[tempFolderName].objectLinks;
                        }

                        if (typeof objects[tempFolderName].nodes !== 'undefined') {
                            objects[tempFolderName].frames[tempFolderName].nodes = objects[tempFolderName].nodes;
                            delete objects[tempFolderName].nodes;
                        }
                        if (typeof objects[tempFolderName].links !== 'undefined') {
                            objects[tempFolderName].frames[tempFolderName].links = objects[tempFolderName].links;
                            delete objects[tempFolderName].links;
                        }

                        for (let frameKey in objects[tempFolderName].frames) {
                            for (let nodeKey in objects[tempFolderName].frames[frameKey].nodes) {
                                if (typeof objects[tempFolderName].frames[frameKey].nodes[nodeKey].item !== 'undefined') {
                                    let tempItem = objects[tempFolderName].frames[frameKey].nodes[nodeKey].item;
                                    objects[tempFolderName].frames[tempFolderName].nodes[nodeKey].data = tempItem[0];
                                }
                            }
                        }

                        // cast everything from JSON to Object, Frame, and Node classes
                        let newObj = new this.ObjectModel(objects[tempFolderName].ip,
                            objects[tempFolderName].version,
                            objects[tempFolderName].protocol,
                            objects[tempFolderName].objectId);
                        newObj.setFromJson(objects[tempFolderName]);
                        objects[tempFolderName] = newObj;
                        // TODO: does this need to be added to sceneGraph?

                        console.log('I found objects that I want to add');

                    } catch (e) {
                        objects[tempFolderName].ip = this.ip.address();
                        objects[tempFolderName].objectId = tempFolderName;
                        console.log('No saved data for: ' + tempFolderName);
                    }

                } else {
                    console.log(' object ' + objectFolderList[i] + ' has no marker yet');
                }
                return tempFolderName;
            }
        }
        return null;
    };

    // todo memory
    deleteObject(objectName, objects, objectsPath, objectLookup, activeHeartbeats, knownObjects, sceneGraph, setAnchors) {
        console.log('Deleting object: ' + objectName);

        let objectFolderPath = this.path.join(objectsPath, objectName);
        if (this.fs.existsSync(objectFolderPath)) {
            this.fs.rmdirSync(objectFolderPath, {recursive: true});
        }

        let objectKey = this.readObject(objectLookup, objectName);

        if (objectKey && objects[objectKey]) {
            // remove object from tree

            if (activeHeartbeats[objectKey]) {
                clearInterval(activeHeartbeats[objectKey]);
                delete activeHeartbeats[objectKey];
            }
            try {
                // deconstructs frames and nodes of this object, too
                objects[objectKey].deconstruct();
            } catch (e) {
                console.warn('Object exists without proper prototype: ' + objectKey, e);
            }
            delete objects[objectKey];
            delete knownObjects[objectKey];
            delete objectLookup[objectName];

            sceneGraph.removeElementAndChildren(objectKey);
        }

        console.log('i deleted: ' + objectKey);
        setAnchors();

        this.actionSender({reloadObject: {object: objectKey}});
    };

    // addons
    loadHardwareInterface(hardwareInterfaceName) {

        let hardwareFolder = this.hardwareIdentity + '/' + hardwareInterfaceName + '/';


        if (!this.fs.existsSync(this.hardwareIdentity)) {
            this.fs.mkdirSync(this.hardwareIdentity, '0766', function (err) {
                if (err) {
                    console.log(err);
                }
            });
        }

        if (!this.fs.existsSync(hardwareFolder)) {
            this.fs.mkdirSync(hardwareFolder, '0766', function (err) {
                if (err) {
                    console.log(err);
                }
            });
        }

        if (!this.fs.existsSync(hardwareFolder + 'settings.json')) {
            this.fs.writeFile(hardwareFolder + 'settings.json', '', function (err) {
                if (err) {
                    console.log(err);
                } else {
                    console.log('JSON created to ' + hardwareFolder + 'settings.json');
                }
            });
        }

        try {
            let fileContents = this.fs.readFileSync(hardwareFolder + 'settings.json', 'utf8');
            let fileContentsJson = JSON.parse(fileContents);
            this.hardwareInterfaces[hardwareInterfaceName] = fileContentsJson;

        } catch (e) {
            console.log('Could not load settings.json for: ' + hardwareInterfaceName);
            this.hardwareInterfaces[hardwareInterfaceName] = {};
        }

        this.read = function (settingsName, defaultvalue) {
            if (typeof this.hardwareInterfaces[hardwareInterfaceName][settingsName] === 'undefined') {
                if (typeof defaultvalue !== 'undefined')
                    this.hardwareInterfaces[hardwareInterfaceName][settingsName] = defaultvalue;
                else {
                    this.hardwareInterfaces[hardwareInterfaceName][settingsName] = 0;
                }
            }
            return this.hardwareInterfaces[hardwareInterfaceName][settingsName];
        };
        return this.read;
    };

    // network
    restActionSender(action) {
        const ipSet = new Set();
        for (const [_key, value] of Object.entries(this.knownObjects)) {
            ipSet.add(value.ip);
        }
        const body = new URLSearchParams({
            'action': JSON.stringify(action)
        });
        [...ipSet].map(objectIp => {
            fetch(`http://${objectIp}:8080/action`, {
                method: 'POST',
                body: body
            }).catch(err => {
                console.warn(`restActionSender: Error sending action to ${objectIp} over REST API.`, err);
            });
        });
    }

    /**
     * Broadcasts a JSON message over UDP
     * @param {*} action - JSON object with no specified structure, contains the message to broadcast
     * @param {number|undefined} timeToLive
     * @param {number|undefined} beatport
     */

    // network
    actionSender(action, timeToLive, beatport) {
        if (!timeToLive) timeToLive = 2;
        if (!beatport) beatport = 52316;
        //  console.log(action);

        var HOST = '255.255.255.255';
        var message;

        message = Buffer.from(JSON.stringify({action: action}));

        if (message.length > 1472) {
            this.restActionSender(action);
            return;
        }

        // creating the datagram
        var client = this.dgram.createSocket({
            type: 'udp4',
            reuseAddr: true,
        });
        client.bind(function () {
            client.setBroadcast(true);
            client.setTTL(timeToLive);
            client.setMulticastTTL(timeToLive);
        });
        // send the datagram
        client.send(message, 0, message.length, beatport, HOST, function (err) {
            if (err) {
                if (err.code === 'EMSGSIZE') {
                    console.error('actionSender: UDP Message Too Large.');
                } else {
                    console.log('You\'re not on a network. Can\'t send anything', err);
                }
            }
            client.close();
        });

    };

    // memory
    doesObjectExist(objects, objectKey) {
        return objects.hasOwnProperty(objectKey);
    }

    // memory
    getObject(objects, objectKey) {
        if (this.doesObjectExist(objects, objectKey)) {
            return objects[objectKey];
        }
        return null;
    }
    // memory
    doesFrameExist(objects, objectKey, frameKey) {
        if (this.doesObjectExist(objects, objectKey)) {
            let foundObject = this.getObject(objects, objectKey);
            if (foundObject) {
                return foundObject.frames.hasOwnProperty(frameKey);
            }
        }
        return false;
    }
    // memory
    getFrame(objects, objectKey, frameKey) {
        if (this.doesFrameExist(objects, objectKey, frameKey)) {
            let foundObject = this.getObject(objects, objectKey);
            if (foundObject) {
                return foundObject.frames[frameKey];
            }
        }
        return null;
    }
    // memory
    doesNodeExist(objects, objectKey, frameKey, nodeKey) {
        if (this.doesFrameExist(objects, objectKey, frameKey)) {
            let foundFrame = this.getFrame(objects, objectKey, frameKey);
            if (foundFrame) {
                return foundFrame.nodes.hasOwnProperty(nodeKey);
            }
        }
        return false;
    }
    // memory
    getNode(objects, objectKey, frameKey, nodeKey) {
        if (this.doesNodeExist(objects, objectKey, frameKey, nodeKey)) {
            let foundFrame = this.getFrame(objects, objectKey, frameKey);
            if (foundFrame) {
                return foundFrame.nodes[nodeKey];
            }
        }
        return null;
    }
    // memory
    /**
     * @param objectKey
     * @param {Function} callback - (error: {failure: bool, error: string}, object)
     */
    getObjectAsync(objects, objectKey, callback) {
        if (!objects.hasOwnProperty(objectKey)) {
            callback({failure: true, error: 'Object ' + objectKey + ' not found'});
            return;
        }
        let object = objects[objectKey];
        callback(null, object);
    }
    // memory
    /**
     * @param objectKey
     * @param frameKey
     * @param {Function} callback - (error: {failure: bool, error: string}, object, frame)
     */
    getFrameAsync(objects, objectKey, frameKey, callback) {
        this.getObjectAsync(objects, objectKey, function (error, object) {
            if (error) {
                callback(error);
                return;
            }
            if (!object.frames.hasOwnProperty(frameKey)) {
                callback({failure: true, error: 'Frame ' + frameKey + ' not found'});
                return;
            }
            let frame = object.frames[frameKey];
            callback(null, object, frame);
        });
    }
    // memory
    /**
     * @param objectKey
     * @param frameKey
     * @param nodeKey
     * @param {Function} callback - (error: {failure: bool, error: string}, object, frame)
     */
    getNodeAsync(objects, objectKey, frameKey, nodeKey, callback) {
        this.getFrameAsync(objects, objectKey, frameKey, function (error, object, frame) {
            if (error) {
                callback(error);
                return;
            }
            if (!frame.nodes.hasOwnProperty(nodeKey)) {
                callback({failure: true, error: 'Node ' + nodeKey + ' not found'});
                return;
            }
            let node = frame.nodes[nodeKey];
            callback(null, object, frame, node);
        });
    }

    /**
     * Returns node if a nodeKey is provided, otherwise the frame
     * @param objectKey
     * @param frameKey
     * @param nodeKey
     * @param callback
     */
    // memory
    getFrameOrNode(objects, objectKey, frameKey, nodeKey, callback) {
        this.getFrameAsync(objects, objectKey, frameKey, function (error, object, frame) {
            if (error) {
                callback(error);
                return;
            }

            let node = null;

            if (nodeKey && nodeKey !== 'null') {
                if (!frame.nodes.hasOwnProperty(nodeKey)) {
                    callback({failure: true, error: 'Node ' + nodeKey + ' not found'});
                    return;
                }
                node = frame.nodes[nodeKey];
            }

            callback(null, object, frame, node);
        });
    }
    // memory
    forEachObject(objects, callback) {
        for (let objectKey in objects) {
            if (!objects.hasOwnProperty(objectKey)) continue;
            callback(objects[objectKey], objectKey);
        }
    }
    // memory
    forEachFrameInObject(object, callback) {
        if (!object) return;
        for (let frameKey in object.frames) {
            if (!object.frames.hasOwnProperty(frameKey)) continue;
            callback(object.frames[frameKey], frameKey);
        }
    }
    // memory
    forEachNodeInFrame(frame, callback) {
        if (!frame) return;
        for (let nodeKey in frame.nodes) {
            if (!frame.nodes.hasOwnProperty(nodeKey)) continue;
            callback(frame.nodes[nodeKey], nodeKey);
        }
    }
    // memory
    forEachLinkInFrame(frame, callback) {
        if (!frame) return;
        for (let nodeKey in frame.links) {
            if (!frame.links.hasOwnProperty(nodeKey)) continue;
            callback(frame.links[nodeKey], nodeKey);
        }
    }

    /**
     * Helper function to return the absolute path to the directory that should contain all
     * video files for the provided object name. (makes dir if necessary)
     * @param objectName
     * @return {string}
     */
    // file
    getVideoDir(objectsPath, identityFolderNameArg, isMobile, objectName) {
        let videoDir = objectsPath; // on mobile, put videos directly in object home dir

        // directory differs on mobile due to inability to call mkdir
        if (!isMobile) {
            videoDir = this.path.join(objectsPath, objectName, identityFolderNameArg, 'videos');

            if (!this.fs.existsSync(videoDir)) {
                console.log('make videoDir');
                this.fs.mkdirSync(videoDir);
            }
        }

        return videoDir;
    }

    // utlity
    // Ensures id is alphanumeric or -_
    isValidId(id) {
        return id.match(/^[A-Za-z0-9_ -]+$/);
    }

    // file
    goesUpDirectory(pathStr) {
        return pathStr.match(/\.\./);
    }

    // utlity
    deepCopy(item) {
        if (null == item || typeof item != 'object') return item;
        if (item instanceof Array) {
            let copy = [];
            for (let i = 0, length = item.length; i < length; i++) {
                copy[i] = this.deepCopy(item[i]);
            }
            return copy;
        }
        if (item instanceof Object) {
            let copy = {};
            for (let key in item) {
                if (item.hasOwnProperty(key)) copy[key] = this.deepCopy(item[key]);
            }
            return copy;
        }
        throw new Error('Unable to deep copy this object.');
    }

    // network
    httpGet(url) {
        return new Promise((resolve, reject) => {
            this.request(url, (error, response, body) => {
                if (error) {
                    reject(error);
                    return;
                }
                if (response.statusCode !== 200) {
                    reject('Invalid status code <' + response.statusCode + '>');
                    return;
                }
                resolve(body);
            });
        });
    };

}
