<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>

<div id="container"></div>
<div id="sidebar" class="region blue smallText">Control Panel</div>

<script src="/socket.io/socket.io.js"></script>

<script>
    var optimizedResize = (function() {

        var callbacks = [],
            running = false;

        // fired on resize event
        function resize() {

            if (!running) {
                running = true;

                if (window.requestAnimationFrame) {
                    window.requestAnimationFrame(runCallbacks);
                } else {
                    setTimeout(runCallbacks, 66);
                }
            }

        }

        // run the actual callbacks
        function runCallbacks() {

            callbacks.forEach(function(callback) {
                callback.callbackFunction.apply(null, callback.callbackArguments);
            });

            running = false;
        }

        // adds callback to loop
        function addCallback(callback, arguments) {

            arguments = arguments || [];

            if (callback) {
                callbacks.push({callbackFunction: callback, callbackArguments: arguments});
            }

        }

        return {
            // public method to add additional callback
            add: function(callback) {
                if (!callbacks.length) {
                    window.addEventListener('resize', resize);
                }
                addCallback(callback);
                runCallbacks();
            }
        }
    }());
</script>

<script>

    var socket = io();
    var container = document.getElementById("container");
    var sidebar = document.getElementById("sidebar");
    var NUM_COLUMNS;
    var NUM_ROWS;
    var MAX_COLUMNS = 5;
    var MIN_COLUMNS = 1;
    var MAX_ROWS = 3;
    var MIN_ROWS = 1;
    var defaultValue = 0.00;
    var createdPanels = [];
    var panelVisualizationTypes = {};
    var currentlyDraggedPanel = null;
    var dragOffsetX = 0;
    var dragOffsetY = 0;
    var mouseX = null;
    var mouseY = null;
    var PANEL_SIZE = 600;

    var arFrameState = {
        flipThreshold: 1000,
        x: 0,
        y: 0,
        isInScreen: true
    };

    window.onload = function() {

        createControlPanel(["decimal", "gauge", "graph", "light"]);

        optimizedResize.add( function() {

            MAX_ROWS = Math.max(1, Math.floor(window.innerHeight / PANEL_SIZE));
            MAX_COLUMNS = Math.max(1, Math.floor(window.innerWidth / PANEL_SIZE));
            // console.log("Max Rows: " + MAX_ROWS);
            // console.log("Max Cols: " + MAX_COLUMNS);

            updateGridButtonAppearance();

        });

        redrawGrid();

        initializeDragInterface();

        socket.on("redrawGrid", function(msg) {
            console.log(msg);
            NUM_ROWS = msg.rows;
            NUM_COLUMNS = msg.columns;
            redrawGrid();
        });

        socket.on('dashboard', function(msg) {

            var nodeName = msg.nodeName;
            var action = msg.action;

            console.log(nodeName, action);

            if (msg.action === "connect") {
                console.log(msg.data);

                if (msg.data.added === true) {
                    console.log("connected!");
                    activatePanel(msg.data.nameNodeB, true);

                } else {
                    console.log("disconnected!");
                    activatePanel(msg.data.nameNodeB, false);

                }
            }

            if (msg.action === "update") {
                console.log("update!");
                console.log(msg.data);
                var panelContents = getPanelContents(nodeName);
                var frame = panelContents.firstChild;
                if (frame.tagName === 'IFRAME') {
                    frame.contentWindow.postMessage({value: msg.data.value}, "http://localhost:3030");
                }
            }

        });

        socket.on('displayLinks', function(msg) {
            console.log('displayLinks');
            console.log(msg);

//            for (var linkKey in msg) {
//                if (!msg.hasOwnProperty(linkKey)) continue;
//
//                var link = msg[linkKey];
//            }

             var linkList = Object.values(msg).map(function(elt) {
                 return elt.namesB[1];
             });

             linkList.forEach( function(panelId) {
                 activatePanel(panelId, true);
             });

//             console.log(linkList);
        });

        socket.on('remoteTouchDown', function(msg) {
            // console.log('remoteTouchDown', msg);
            simulateMouseEvent(msg.pageX, msg.pageY, 'mousedown');
        });

        socket.on('remoteTouchMove', function(msg) {
            // console.log('remoteTouchMove', msg);
            simulateMouseEvent(msg.pageX, msg.pageY, 'mousemove');
        });

        socket.on('remoteTouchUp', function(msg) {
            console.log('remoteTouchUp', msg);
            arFrameState.isInScreen = true;
            simulateMouseEvent(msg.pageX, msg.pageY, 'mouseup');
        });

        socket.on('zWhilePointerDown', function(msg) {
            var zPosition = msg.zPosition;

            // console.log('1');

            if (currentlyDraggedPanel) {

                // console.log('2');

                var draggedPanelX = parseInt(currentlyDraggedPanel.style.left);
                var draggedPanelY = parseInt(currentlyDraggedPanel.style.top);

                var frameType = currentlyDraggedPanel.id;

                // console.log('xPosition: ' + draggedPanelX, 'yPosition: ' + draggedPanelY, 'zPosition: ' + zPosition);

                var msgData = {
                    destination: 'ar',
                    xPosition: draggedPanelX,
                    yPosition: draggedPanelY,
                    zPosition: zPosition,
                    frameData: {
                        uniqueName: frameType + uuidTime(),
                        type: frameType
                    }
                };

                if (arFrameState.isInScreen) {

                    // console.log('3');

                    if (zPosition > arFrameState.flipThreshold) {

                        console.log('send to 3D');

                        // hide the 2D frame on the hardware interface and display a 3D frame in the editor
                        // making sure to set the 3D frame to the correct position
                        currentlyDraggedPanel.style.opacity = 0.5;

                        socket.emit('transportFrame', msgData);

                        arFrameState.isInScreen = false;

                    }

                } else {

                    if (zPosition < arFrameState.flipThreshold) {

                        console.log('send to 2D');

                        // hide the 3D frame in the editor and show the 2D frame on the hardware interface
                        // making sure to set the 2D frame to the correct position
                        currentlyDraggedPanel.style.opacity = 1;

                        msgData.destination = 'screen';

                        socket.emit('transportFrame', msgData);

                        arFrameState.isInScreen = true;

                    }

                }

            }

        });

    };

    function simulateMouseEvent(x,y,eventName) {
        mouseX = x * 2.0;
        mouseY = y * 2.0;

        var ev = new MouseEvent(eventName, {
            'view': window,
            'bubbles': true,
            'cancelable': true,
            'screenX': x,
            'screenY': y
        });
        ev.simulated = true;

        var el = document.elementFromPoint(x, y);
        el.dispatchEvent(ev);
    }

    function redrawGrid() {

        container.style.width = PANEL_SIZE * NUM_COLUMNS + "px"; //50 + (30 * NUM_COLUMNS / MAX_COLUMNS) + "%";
        container.style.height = PANEL_SIZE * NUM_ROWS + "px"; //1000 + (800 * NUM_ROWS / MAX_ROWS) + "px";

        container.innerHTML = "";
        createdPanels = createPanels(NUM_ROWS, NUM_COLUMNS);

        socket.emit('dashboardLoaded');

        updateGridButtonAppearance();
    }

    function updateGridButtonAppearance() {
        var buttonIds = ["moreColumns", "fewerColumns", "moreRows", "fewerRows"];
        buttonIds.forEach(function(buttonId) {
            document.getElementById(buttonId).classList.remove("inactive");
            document.getElementById(buttonId).classList.add('active');
        });
        if (NUM_COLUMNS >= MAX_COLUMNS) {
            document.getElementById("moreColumns").classList.add("inactive");
            document.getElementById("moreColumns").classList.remove('active');
        } else if (NUM_COLUMNS <= MIN_COLUMNS) {
            document.getElementById("fewerColumns").classList.add("inactive");
            document.getElementById("fewerColumns").classList.remove('active');
        }
        if (NUM_ROWS >= MAX_ROWS) {
            document.getElementById("moreRows").classList.add("inactive");
            document.getElementById("moreRows").classList.remove('active');
        } else if (NUM_ROWS <= MIN_ROWS) {
            document.getElementById("fewerRows").classList.add("inactive");
            document.getElementById("fewerRows").classList.remove('active');
        }
    }

    function createPanels(rows, columns) {

        var panelArray = [];

        for (var r = 0; r < rows; r++) {
            for (var c = 0; c < columns; c++) {

                var newPanel = document.createElement("div");
                newPanel.classList.add("region");
                newPanel.id = getIdForPanel(r, c);
                newPanel.style.width = ((1.0 / columns) * 100) + "%";
                newPanel.style.height = ((1.0 / rows) * 100) + "%";
                newPanel.style.left = (((1.0 / columns) * 100) * c) + "%";
                newPanel.style.top = (((1.0 / rows) * 100) * r) + "%";

                container.appendChild(newPanel);

                var eventCaptureDiv = document.createElement('div');
                eventCaptureDiv.className = "eventCapture";
                newPanel.appendChild(eventCaptureDiv);

                var centerContentsOuter = document.createElement("div");
                centerContentsOuter.className = "centerContentsOuter";
                newPanel.appendChild(centerContentsOuter);

                var centerContentsInner = document.createElement("div");
                centerContentsInner.classList.add("centerContentsInner");
                centerContentsInner.classList.add("blue");
                centerContentsOuter.appendChild(centerContentsInner);

                if (r === 0 && c === 0) {
                    centerContentsInner.classList.add("marker");
                } else {

                    if (!panelVisualizationTypes.hasOwnProperty(newPanel.id)) {
                        panelVisualizationTypes[newPanel.id] = "empty";
                    }

                    activatePanel(newPanel.id, false);
                }

                panelArray.push(newPanel);
            }
        }
        return panelArray;
    }

    function getIdForPanel(row, column) {
        return "panel_row" + row + "_col" + column;
    }

    function getPanelContents(nodeName) {
        var panel = document.getElementById(nodeName);
        if (panel) {
            return document.getElementById(nodeName).children[1].firstElementChild;
        } else {
            return null;
        }
    }

    function activatePanel(nodeName, shouldBeActive) {
        var panelContents = getPanelContents(nodeName);

        if (!panelContents) return;
        
        if (shouldBeActive) {
            panelContents.classList.remove("inactive");
            panelContents.classList.add("active");
            panelContents.innerHTML = "Connected.\nAdd a visualizer.";
        } else {
            panelContents.classList.remove("active");
            panelContents.classList.add("inactive");
            panelContents.innerHTML = "No Connection";
        }

        if (panelVisualizationTypes.hasOwnProperty(nodeName) && !(panelVisualizationTypes[nodeName] === "empty")) {
            var visualizationType = panelVisualizationTypes[nodeName];
            setPanelDisplay(document.getElementById(nodeName), visualizationType);
        }

        panelContents.classList.remove("greenText");
        panelContents.classList.remove("redText");
        panelContents.classList.remove("whiteText");

        panelContents.classList.remove("largeText");
        panelContents.classList.add("smallText");

    }

    function createSidebarPanel(controlName) {
        var sidebarPanel = document.createElement("div");
        sidebarPanel.className = "sidebarPanel";
        sidebarPanel.id = controlName;

        var eventCaptureDiv = document.createElement('div');
        eventCaptureDiv.className = "eventCapture";
        sidebarPanel.appendChild(eventCaptureDiv);

        var centerContentsOuter = document.createElement("div");
        centerContentsOuter.className = "centerContentsOuter";
        sidebarPanel.appendChild(centerContentsOuter);

        var centerContentsInner = document.createElement("div");
        centerContentsInner.classList.add("centerContentsInner");
        centerContentsInner.classList.add("blue");
        centerContentsInner.classList.add("active");

        centerContentsOuter.appendChild(centerContentsInner);

        var frame = createFrame(controlName);
        centerContentsInner.appendChild(frame);

        return sidebarPanel;
    }

    function createFrame(frameType) {
        var frameDomElement = document.createElement('iframe');
        frameDomElement.classList.add('controlFrame');
        frameDomElement.frameType = frameType;
        frameDomElement.id = frameType + 'Frame';
        frameDomElement.src = '/frames/' + frameType + '.html';
        frameDomElement.scrolling = 'no';
        frameDomElement.style.border = '0px solid transparent';
        frameDomElement.onload = function() {
            frameDomElement.contentWindow.postMessage({value: defaultValue}, 'http://localhost:3030'); // TODO: change localhost in production?
        };
        return frameDomElement;
    }

    function createControlPanel(controls) {

        sidebar.style.width = "400px";
        sidebar.style.height = "1200px";

        controls.forEach( function(controlName) {
            var sidebarPanel = createSidebarPanel(controlName);
            sidebar.appendChild(sidebarPanel);
        });

        appendGridResizeButton("moreColumns", "Columns +", addColumn);
        appendGridResizeButton("fewerColumns", "Columns -", removeColumn);
        sidebar.appendChild(document.createElement('br'));
        appendGridResizeButton("moreRows", "Rows +", addRow);
        appendGridResizeButton("fewerRows", "Rows -", removeRow);
    }

    function appendGridResizeButton(id, innerHTML, clickCallback) {
        var thisButton = document.createElement("button");
        thisButton.id = id;
        thisButton.classList.add('button');
        thisButton.classList.add('blue');
        thisButton.classList.add('active');
        thisButton.innerHTML = innerHTML;
        thisButton.addEventListener('click', clickCallback);
        sidebar.appendChild(thisButton);
    }

    function addColumn() {
        if (NUM_COLUMNS < MAX_COLUMNS) {
            NUM_COLUMNS++;
            socket.emit("addColumn");
        }
    }

    function removeColumn() {
        if (NUM_COLUMNS > MIN_COLUMNS) {
            NUM_COLUMNS--;
            socket.emit("removeColumn");
        }
    }

    function addRow() {
        if (NUM_ROWS < MAX_ROWS) {
            NUM_ROWS++;
            socket.emit("addRow");
        }
    }

    function removeRow() {
        if (NUM_ROWS > MIN_ROWS) {
            NUM_ROWS--;
            socket.emit("removeRow");
        }
    }

    function initializeDragInterface() {

        var timer;
        var clickedPanelContainer = null;

        // add event listeners for mouse down, up, move, (cancel?)

        document.addEventListener('mousedown', onMouseDown);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
//        document.addEventListener('mouseout', onMouseUpdate, false);

        var interactionState = getStates().NONE;

        function onMouseDown(e) {
            console.log("mousedown", interactionState);
            interactionState = performAction(getActions().MOUSE_DOWN, interactionState);
        }

        function onMouseMove(e) {
            // console.log("mousemove", interactionState);

            // remote touch came from phone
            if (e.simulated) {
                mouseX = e.screenX * 2.0;
                mouseY = e.screenY * 2.0;
            } else {
                mouseX = e.pageX;
                mouseY = e.pageY;
            }

            interactionState = performAction(getActions().MOUSE_MOVE, interactionState);

            // console.log(currentlyDraggedPanel);
            if (currentlyDraggedPanel) {
                currentlyDraggedPanel.style.top = mouseY + dragOffsetY + "px"; // + 20
                currentlyDraggedPanel.style.left = mouseX + dragOffsetX + "px"; // + 20
            }
        }

        function onMouseUp(e) {
            console.log("mouseup", interactionState);
            interactionState = performAction(getActions().MOUSE_UP, interactionState);
        }

        // maintain a state machine that triggers actions upon entering each state

        function getStates() {
            return {
                NONE: 0,
                CLICK: 1,
                HOLD: 3,
                DRAG: 5
            };
        }

        function getActions() {
            return {
                NONE: 0,
                MOUSE_DOWN: 1,
                MOUSE_MOVE: 2,
                MOUSE_UP: 3,
                MOUSE_CANCEL: 4,
                TIME_PASSED: 5
            };
        }

        function getEvents() {
            return {
                MOUSE_START_CLICK: 0,
                MOUSE_STOP_CLICK: 1,
                MOUSE_START_HOLD: 2,
                MOUSE_STOP_HOLD: 3,
                MOUSE_START_DRAG: 4,
                MOUSE_STOP_DRAG: 5
            };
        }

        function performAction(action, currentState) {

            if (action === getActions().MOUSE_DOWN) {
                if (currentState === getStates().NONE) {
                    triggerEvent(getEvents().MOUSE_START_CLICK);
                    return getStates().CLICK;
                }

            } else if (action === getActions().TIME_PASSED) {
                if (currentState === getStates().CLICK) {
                    triggerEvent(getEvents().MOUSE_START_HOLD);
                    return getStates().HOLD;
                }

            } else if (action === getActions().MOUSE_MOVE) {
                if (currentState === getStates().CLICK || currentState === getStates().HOLD) {
                    triggerEvent(getEvents().MOUSE_START_DRAG);
                    return getStates().DRAG;
                }

            } else if (action === getActions().MOUSE_UP || action === getActions().MOUSE_CANCEL) {
                if (currentState === getStates().CLICK) {
                    triggerEvent(getEvents().MOUSE_STOP_CLICK)
                } else if (currentState === getStates().HOLD) {
                    triggerEvent(getEvents().MOUSE_START_HOLD);
                } else if (currentState === getStates().DRAG) {
                    triggerEvent(getEvents().MOUSE_STOP_DRAG);
                }

                return getStates().NONE;

            }
            return currentState;
        }

        function triggerEvent(event) {
            clearTimeout(timer);
            switch (event) {
                case getEvents().MOUSE_START_CLICK:
                    startClick();
                    timer = setTimeout(function(){
                        interactionState = performAction(getActions().TIME_PASSED, interactionState);
                    }, 1000);
                    break;
                case getEvents().MOUSE_START_HOLD:
                    startHoldOrDrag();
                    break;
                case getEvents().MOUSE_START_DRAG:
                    startHoldOrDrag();
                    break;
                case getEvents().MOUSE_STOP_CLICK:
                    break;
                case getEvents().MOUSE_STOP_HOLD:
                case getEvents().MOUSE_STOP_DRAG:
                    stopHoldOrDrag();
                    break;
                default:
                    console.log("shouldn't happen");
            }
        }

        function startClick() {
            clickedPanelContainer = null;
            var allDivsHere = getAllDivsUnderCoordinate(mouseX, mouseY);
            allDivsHere.some( function(clickedElement) {
                if (clickedElement.classList.contains('sidebarPanel')) {
                    clickedPanelContainer = clickedElement;
                    dragOffsetX = clickedPanelContainer.getBoundingClientRect().x - mouseX;
                    dragOffsetY = clickedPanelContainer.getBoundingClientRect().y - mouseY;
                }
                return (!!clickedPanelContainer);
            });
        }

        function startHoldOrDrag() {
            if (!currentlyDraggedPanel && clickedPanelContainer) {
                var sidebarPanelClone = createSidebarPanel(clickedPanelContainer.id);
                sidebarPanelClone.classList.add("region");
                sidebarPanelClone.classList.add("smallText");
                currentlyDraggedPanel = sidebarPanelClone;
                currentlyDraggedPanel.style.position = "absolute";
                document.getElementsByTagName('body')[0].appendChild(currentlyDraggedPanel);
                sidebarPanelClone.classList.add("draggedPanel");
                clickedPanelContainer = null;
            }
        }

        function stopHoldOrDrag() {
            if (currentlyDraggedPanel) {
                // get panel it's on top of
                var allDivsHere = getAllDivsUnderCoordinate(mouseX, mouseY);
                allDivsHere.forEach( function(element) {
                    if (element.classList.contains('region') &&  element.id.startsWith('panel_') && element.id !== 'panel_row0_col0') {
                        console.log('released on panel');
                        panelVisualizationTypes[element.id] = currentlyDraggedPanel.id;
                        setPanelDisplay(element, currentlyDraggedPanel.id);
                    }
                });

                document.getElementsByTagName('body')[0].removeChild(currentlyDraggedPanel);
                currentlyDraggedPanel = null;
            }
        }

        function getAllDivsUnderCoordinate(x, y) {
            var res = [];

            var ele = document.elementFromPoint(x,y);
            while(ele && ele.tagName !== "BODY" && ele.tagName !== "HTML"){
                res.push(ele);
                ele.style.display = "none";
                ele = document.elementFromPoint(x,y);
            }

            for(var i = 0; i < res.length; i++){
                res[i].style.display = "";  // TODO: more correct if you set back to original display type
            }
            console.log(res);
            return res;
        }
    }

    function setPanelDisplay(panel, controlName) {

        var iframeWidthPercentage = 0.9;
        var iframeHeightToWidthRatio = 0.5;

        getPanelContents(panel.id).innerHTML = "";
        var frame = createFrame(controlName);
        frame.style.width = (getPanelContents(panel.id).clientWidth * iframeWidthPercentage) + "px";
        frame.style.height = (getPanelContents(panel.id).clientHeight * iframeWidthPercentage * iframeHeightToWidthRatio) + "px";

        getPanelContents(panel.id).appendChild(frame);
    }

    // ..... UTILITIES ..... //

    // copied from userinterface realityEditor.device.utilities.uuidTime
    function uuidTime() {
        var dateUuidTime = new Date();
        var abcUuidTime = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var stampUuidTime = parseInt(Math.floor((Math.random() * 199) + 1) + "" + dateUuidTime.getTime()).toString(36);
        while (stampUuidTime.length < 12) stampUuidTime = abcUuidTime.charAt(Math.floor(Math.random() * abcUuidTime.length)) + stampUuidTime;
        return stampUuidTime;
    }

</script>
</body>
</html>
