<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>

<div id="container"></div>
<div id="sidebar" class="region blue smallText">Control Panel</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();

    var container = document.getElementById("container");
    container.style.width = "50%";
    container.style.height = "900px";

    var sidebar = document.getElementById("sidebar");
    createControlPanel(["decimal", "gauge", "graph", "light"]);

    var NUM_COLUMNS;
    var NUM_ROWS;
    var MAX_COLUMNS = 8;
    var MIN_COLUMNS = 1;
    var MAX_ROWS = 8;
    var MIN_ROWS = 1;

    //    var createdPanels = createPanels(3,4); // need to wait until HW interface connects
    var createdPanels = [];
    socket.on("redrawGrid", function(msg) {
        console.log(msg);
        NUM_ROWS = msg.rows;
        NUM_COLUMNS = msg.columns;
        redrawGrid();
    });

    function redrawGrid() {
        container.innerHTML = "";
        createdPanels = createPanels(NUM_ROWS, NUM_COLUMNS);

        container.style.width = 50 + (30 * NUM_COLUMNS / MAX_COLUMNS) + "%";
        container.style.height = 1000 + (800 * NUM_ROWS / MAX_ROWS) + "px";

    }

//    var controls = ["decimal", "gauge", "graph", "light"];

    function createPanels(rows, columns) {

        var panelArray = [];

        for (var r = 0; r < rows; r++) {
            for (var c = 0; c < columns; c++) {

                var newPanel = document.createElement("div");
                newPanel.classList.add("region");
                newPanel.id = getIdForPanel(r, c);
                newPanel.style.width = ((1.0 / columns) * 100) + "%";
                newPanel.style.height = ((1.0 / rows) * 100) + "%";
                newPanel.style.left = (((1.0 / columns) * 100) * c) + "%";
                newPanel.style.top = (((1.0 / rows) * 100) * r) + "%";

                container.appendChild(newPanel);

                newPanel.addEventListener('click', function(e) {
//                    toggleConnected(e.currentTarget);
                    clickedOnPanel(e.currentTarget);
                });

                var centerContentsOuter = document.createElement("div");
                centerContentsOuter.className = "centerContentsOuter";
                newPanel.appendChild(centerContentsOuter);

                var centerContentsInner = document.createElement("div");
                centerContentsInner.classList.add("centerContentsInner");
                centerContentsInner.classList.add("blue");
                centerContentsOuter.appendChild(centerContentsInner);

                if (r === 0 && c === 0) {

                    centerContentsInner.classList.add("marker");
//                    var markerImage = document.createElement("div");
//                    markerImage.classList.add("marker");
//                    markerImage.src = "marker.jpg";
//                    centerContentsInner.appendChild(markerImage);
                } else {
                    activatePanel(getIdForPanel(r, c), false);
                }

                panelArray.push(newPanel);
            }
        }
        return panelArray;
    }

    function getIdForPanel(row, column) {
        return "panel_row" + row + "_col" + column;
    }

    function getPanelContents(nodeName) {
        return document.getElementById(nodeName).firstElementChild.firstElementChild;
    }

    function activatePanel(nodeName, shouldBeActive) {
        var panelContents = getPanelContents(nodeName);

        if (shouldBeActive) {
            panelContents.classList.remove("inactive");
            panelContents.classList.add("active");
            panelContents.innerHTML = "Connected";
        } else {
            panelContents.classList.remove("active");
            panelContents.classList.add("inactive");
            panelContents.innerHTML = "No Connection";
        }

        panelContents.classList.remove("greenText");
        panelContents.classList.remove("redText");
        panelContents.classList.remove("whiteText");

        panelContents.classList.remove("largeText");
        panelContents.classList.add("smallText");

    }

    function updatePanelText(nodeName, value) {
        var panelContents = getPanelContents(nodeName);

        panelContents.innerHTML = value.toFixed(2);// + '\n' + data.nameObjectA + " - " + data.nameNodeA;

        panelContents.classList.remove("greenText");
        panelContents.classList.remove("redText");
        panelContents.classList.remove("whiteText");

        if (value > 0) {
            panelContents.classList.add("greenText");
        } else if (value === 0) {
            panelContents.classList.add("whiteText");
        } else {
            panelContents.classList.add("redText");
        }

        panelContents.classList.remove("smallText");
        panelContents.classList.add("largeText");

    }

    socket.on('dashboard', function(msg) {

        var nodeName = msg.nodeName;
        var action = msg.action;

        console.log(nodeName, action);

        if (msg.action === "connect") {
            console.log(msg.data);

            if (msg.data.added === true) {
                console.log("connected!");
                activatePanel(msg.data.nameNodeB, true);

            } else {
                console.log("disconnected!");
                activatePanel(msg.data.nameNodeB, false);

            }
        }

        if (msg.action === "update") {
            console.log("update!");
            console.log(msg.data);
//            if (document.getElementById(nodeName).controlType !== "gauge") {
//                updatePanelText(nodeName, msg.data.value);
//            } else {
                var panelContents = getPanelContents(nodeName);
                var frame = panelContents.firstChild;
                frame.contentWindow.postMessage({value: msg.data.value}, "http://localhost:3030");//, "https://robertnyman.com");
//            }
        }

    });

    function createSidebarPanel(controlName) {
        var sidebarPanel = document.createElement("div");
        sidebarPanel.className = "sidebarPanel";
        sidebarPanel.id = controlName;

        var centerContentsOuter = document.createElement("div");
        centerContentsOuter.className = "centerContentsOuter";
        sidebarPanel.appendChild(centerContentsOuter);

        var centerContentsInner = document.createElement("div");
        centerContentsInner.classList.add("centerContentsInner");
        centerContentsInner.classList.add("blue");
        centerContentsInner.classList.add("active");

        centerContentsOuter.appendChild(centerContentsInner);

        if (controlName === 'decimal') {
            var decimalFrame = createDecimalFrame();
            centerContentsInner.appendChild(decimalFrame);

        } else if (controlName === 'gauge') {
            var gaugeFrame = createGaugeFrame();
            centerContentsInner.appendChild(gaugeFrame);

        } else if (controlName === 'graph') {
            var graphFrame = createGraphFrame();
            centerContentsInner.appendChild(graphFrame);

        } else if (controlName === 'light') {
            var lightFrame = createLightFrame();
            centerContentsInner.appendChild(lightFrame);

        } else {
            centerContentsInner.innerHTML = controlName;
        }


        return sidebarPanel;
    }

    var defaultValue = 0.00;

    function createDecimalFrame() {
        var decimalFrame = document.createElement('iframe');
        decimalFrame.id = 'decimalFrame';
        decimalFrame.src = "/frame_decimal.html";
        decimalFrame.scrolling = "no";
        decimalFrame.style.border = "0px solid transparent";
        decimalFrame.onload = function(e) {
            decimalFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return decimalFrame;
    }

    function createGaugeFrame() {
        var gaugeFrame = document.createElement('iframe');
        gaugeFrame.id = 'gaugeFrame';
        gaugeFrame.src = "/frame_gauge.html";
        gaugeFrame.scrolling = "no";
        gaugeFrame.style.border = "0px solid transparent";
        gaugeFrame.onload = function(e) {
            gaugeFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return gaugeFrame;
    }

    function createGraphFrame() {
        var graphFrame = document.createElement('iframe');
        graphFrame.id = 'graphFrame';
        graphFrame.src = "/frame_graph.html";
        graphFrame.scrolling = "no";
        graphFrame.style.border = "0px solid transparent";
        graphFrame.onload = function(e) {
            graphFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return graphFrame;
    }

    function createLightFrame() {
        var lightFrame = document.createElement('iframe');
        lightFrame.id = 'lightFrame';
        lightFrame.src = "/frame_light.html";
        lightFrame.scrolling = "no";
        lightFrame.style.border = "0px solid transparent";
        lightFrame.onload = function(e) {
            lightFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return lightFrame;
    }

    function createControlPanel(controls) {

        startLoop();

        sidebar.style.width = "400px";
        sidebar.style.height = "1200px";

        controls.forEach( function(controlName) {

            var sidebarPanel = createSidebarPanel(controlName);
            sidebar.appendChild(sidebarPanel);
            sidebarPanel.addEventListener('click', sidebarPanelClick);
//            sidebarPanel.addEventListener('mousedown', sidebarPanelMouseDown);
//            sidebarPanel.addEventListener('mousedown', sidebarPanelMouseDown);
        });

        var moreColumnsButton = document.createElement("button");
        moreColumnsButton.classList.add('button');
        moreColumnsButton.classList.add('blue');
        moreColumnsButton.classList.add('active');
        moreColumnsButton.innerHTML = "Columns +";
        moreColumnsButton.addEventListener('click', addColumn);
        sidebar.appendChild(moreColumnsButton);

        var fewerColumnsButton = document.createElement("button");
        fewerColumnsButton.classList.add('button');
        fewerColumnsButton.classList.add('blue');
        fewerColumnsButton.classList.add('active');
        fewerColumnsButton.innerHTML = "Columns -";
        fewerColumnsButton.addEventListener('click', removeColumn);
        sidebar.appendChild(fewerColumnsButton);

        sidebar.appendChild(document.createElement('br'));

        var moreRowsButton = document.createElement("button");
        moreRowsButton.classList.add('button');
        moreRowsButton.classList.add('blue');
        moreRowsButton.classList.add('active');
        moreRowsButton.innerHTML = "Rows +";
        moreRowsButton.addEventListener('click', addRow);
        sidebar.appendChild(moreRowsButton);

        var fewerRowsButton = document.createElement("button");
        fewerRowsButton.classList.add('button');
        fewerRowsButton.classList.add('blue');
        fewerRowsButton.classList.add('active');
        fewerRowsButton.innerHTML = "Rows -";
        fewerRowsButton.addEventListener('click', removeRow);
        sidebar.appendChild(fewerRowsButton);
    }

    function addColumn(e) {
        if (NUM_COLUMNS < MAX_COLUMNS) {
            NUM_COLUMNS++;
            // redraw interface, etc
//            redrawGrid();
            // communicate to nodes
//            updateServerNodes(0,1);
            socket.emit("addColumn");
        }
    }

    function removeColumn(e) {
        if (NUM_COLUMNS > MIN_COLUMNS) {
            NUM_COLUMNS--;
            // redraw
//            redrawGrid();
            // communicate to nodes
//            updateServerNodes(0,-1);
            socket.emit("removeColumn");

        }
    }

    function addRow(e) {
        if (NUM_ROWS < MAX_ROWS) {
            NUM_ROWS++;
            // redraw interface, etc
//            redrawGrid();
            // communicate to nodes
//            updateServerNodes(1,0);
            socket.emit("addRow");

        }
    }

    function removeRow(e) {
        if (NUM_ROWS > MIN_ROWS) {
            NUM_ROWS--;
            // redraw
//            redrawGrid();
            // communicate to nodes
//            updateServerNodes(-1,0);
            socket.emit("removeRow");

        }
    }

    var currentlyDraggedPanel = null;

    function sidebarPanelClick(e) {
        console.log("clicked on sidebar panel", e);
        console.log(e.currentTarget);

        if (!currentlyDraggedPanel) {
            var sidebarPanelClone = createSidebarPanel(e.currentTarget.id);
            sidebarPanelClone.classList.add("region");
            sidebarPanelClone.classList.add("smallText");
//            .appendChild(currentlyDraggedPanel);
            currentlyDraggedPanel = sidebarPanelClone;
            document.getElementsByTagName('body')[0].appendChild(currentlyDraggedPanel);
            sidebarPanelClone.classList.add("draggedPanel");
        }
    }

    function startLoop() {
        setInterval(function () {
            if (currentlyDraggedPanel) {
//                currentlyDraggedPanel.style.left = mouseX;
//                currentlyDraggedPanel.style.top = mouseY;
//                console.log(currentlyDraggedPanel);
//                console.log('moved to ', currentlyDraggedPanel.style.left, currentlyDraggedPanel.style.top);

                currentlyDraggedPanel.style.position = "absolute";

//                console.log( mouseY - (mouseY - currentlyDraggedPanel.offsetTop) + "px" );
//                console.log(mouseX, mouseY);

                currentlyDraggedPanel.style.top = mouseY + 20 + "px"; //mouseY - (mouseY - currentlyDraggedPanel.offsetTop) + "px";
                currentlyDraggedPanel.style.left = mouseX + 20 + "px"; //mouseX - (mouseX - currentlyDraggedPanel.offsetLeft) + "px";
            }
        }, 16.67);
    }

    var mouseX = null;
    var mouseY = null;

    document.addEventListener('mousemove', onMouseUpdate, false);
    document.addEventListener('mouseenter', onMouseUpdate, false);

    function onMouseUpdate(e) {
        mouseX = e.pageX;
        mouseY = e.pageY;
//        console.log('mouse moved', mouseX, mouseY);
    }

    function clickedOnPanel(panel) {

        if (currentlyDraggedPanel) {
            console.log('clicked on panel');

            setPanelDisplay(panel, currentlyDraggedPanel.id);

//        activatePanel(panel.id, !getPanelContents(panel.id).classList.contains("active"));

            document.getElementsByTagName('body')[0].removeChild(currentlyDraggedPanel);
            currentlyDraggedPanel = null;
        }

    }

    function setPanelDisplay(panel, controlName) {

        getPanelContents(panel.id).innerHTML = controlName;
        panel.controlType = controlName;

        if (controlName === "decimal") {
            getPanelContents(panel.id).innerHTML = "";
            var decimalFrame = createDecimalFrame();
            getPanelContents(panel.id).appendChild(decimalFrame);

        } else if (controlName === "gauge") {
            getPanelContents(panel.id).innerHTML = "";
            var gaugeFrame = createGaugeFrame();
            getPanelContents(panel.id).appendChild(gaugeFrame);

        } else if (controlName === "graph") {
            getPanelContents(panel.id).innerHTML = "";
            var graphFrame = createGraphFrame();
            getPanelContents(panel.id).appendChild(graphFrame);

        } else if (controlName === "light") {
            getPanelContents(panel.id).innerHTML = "";
            var lightFrame = createLightFrame();
            getPanelContents(panel.id).appendChild(lightFrame);
        }

    }

</script>
</body>
</html>
