<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>

<div id="container"></div>
<div id="sidebar" class="region blue smallText">Control Panel</div>

<script src="/socket.io/socket.io.js"></script>
<script>

    var socket = io();
    var container = document.getElementById("container");
    var sidebar = document.getElementById("sidebar");
    var NUM_COLUMNS;
    var NUM_ROWS;
    var MAX_COLUMNS = 5;
    var MIN_COLUMNS = 1;
    var MAX_ROWS = 3;
    var MIN_ROWS = 1;
    var defaultValue = 0.00;
    var createdPanels = [];
    var panelVisualizationTypes = {};
    var currentlyDraggedPanel = null;
    var mouseX = null;
    var mouseY = null;

    createControlPanel(["decimal", "gauge", "graph", "light"]);
    redrawGrid();

//    document.addEventListener('mousemove', onMouseUpdate, false);
//    document.addEventListener('mouseenter', onMouseUpdate, false);

    initializeDragInterface();

    socket.on("redrawGrid", function(msg) {
        console.log(msg);
        NUM_ROWS = msg.rows;
        NUM_COLUMNS = msg.columns;
        redrawGrid();
    });

    function redrawGrid() {

        container.style.width = 600 * NUM_COLUMNS + "px"; //50 + (30 * NUM_COLUMNS / MAX_COLUMNS) + "%";
        container.style.height = 600 * NUM_ROWS + "px"; //1000 + (800 * NUM_ROWS / MAX_ROWS) + "px";

        container.innerHTML = "";
        createdPanels = createPanels(NUM_ROWS, NUM_COLUMNS);

        updateGridButtonAppearance();
    }

    function updateGridButtonAppearance() {
        var buttonIds = ["moreColumns", "fewerColumns", "moreRows", "fewerRows"];
        buttonIds.forEach(function(buttonId) {
            document.getElementById(buttonId).classList.remove("inactive");
            document.getElementById(buttonId).classList.add('active');
        });
        if (NUM_COLUMNS >= MAX_COLUMNS) {
            document.getElementById("moreColumns").classList.add("inactive");
            document.getElementById("moreColumns").classList.remove('active');
        } else if (NUM_COLUMNS <= MIN_COLUMNS) {
            document.getElementById("fewerColumns").classList.add("inactive");
            document.getElementById("fewerColumns").classList.remove('active');
        }
        if (NUM_ROWS >= MAX_ROWS) {
            document.getElementById("moreRows").classList.add("inactive");
            document.getElementById("moreRows").classList.remove('active');
        } else if (NUM_ROWS <= MIN_ROWS) {
            document.getElementById("fewerRows").classList.add("inactive");
            document.getElementById("fewerRows").classList.remove('active');
        }
    }

    function createPanels(rows, columns) {

        var panelArray = [];

        for (var r = 0; r < rows; r++) {
            for (var c = 0; c < columns; c++) {

                var newPanel = document.createElement("div");
                newPanel.classList.add("region");
                newPanel.id = getIdForPanel(r, c);
                newPanel.style.width = ((1.0 / columns) * 100) + "%";
                newPanel.style.height = ((1.0 / rows) * 100) + "%";
                newPanel.style.left = (((1.0 / columns) * 100) * c) + "%";
                newPanel.style.top = (((1.0 / rows) * 100) * r) + "%";

                container.appendChild(newPanel);

//                newPanel.addEventListener('click', function(e) {
//                    clickedOnPanel(e.currentTarget);
//                });

                var eventCaptureDiv = document.createElement('div');
                eventCaptureDiv.className = "eventCapture";
                newPanel.appendChild(eventCaptureDiv);

                var centerContentsOuter = document.createElement("div");
                centerContentsOuter.className = "centerContentsOuter";
                newPanel.appendChild(centerContentsOuter);

                var centerContentsInner = document.createElement("div");
                centerContentsInner.classList.add("centerContentsInner");
                centerContentsInner.classList.add("blue");
                centerContentsOuter.appendChild(centerContentsInner);

                if (r === 0 && c === 0) {
                    centerContentsInner.classList.add("marker");
                } else {

                    if (!panelVisualizationTypes.hasOwnProperty(newPanel.id)) {
                        panelVisualizationTypes[newPanel.id] = "empty";
                    }

                    activatePanel(newPanel.id, false);
                }

                panelArray.push(newPanel);
            }
        }
        return panelArray;
    }

    function getIdForPanel(row, column) {
        return "panel_row" + row + "_col" + column;
    }

    function getPanelContents(nodeName) {
        return document.getElementById(nodeName).children[1].firstElementChild;
    }

    function activatePanel(nodeName, shouldBeActive) {
        var panelContents = getPanelContents(nodeName);

        if (shouldBeActive) {
            panelContents.classList.remove("inactive");
            panelContents.classList.add("active");
            panelContents.innerHTML = "Connected.\nAdd a visualizer.";
        } else {
            panelContents.classList.remove("active");
            panelContents.classList.add("inactive");
            panelContents.innerHTML = "No Connection";
        }

        if (panelVisualizationTypes.hasOwnProperty(nodeName) && !(panelVisualizationTypes[nodeName] === "empty")) {
            var visualizationType = panelVisualizationTypes[nodeName];
            setPanelDisplay(document.getElementById(nodeName), visualizationType);
        }

        panelContents.classList.remove("greenText");
        panelContents.classList.remove("redText");
        panelContents.classList.remove("whiteText");

        panelContents.classList.remove("largeText");
        panelContents.classList.add("smallText");

    }

    function updatePanelText(nodeName, value) {
        var panelContents = getPanelContents(nodeName);

        panelContents.innerHTML = value.toFixed(2);// + '\n' + data.nameObjectA + " - " + data.nameNodeA;

        panelContents.classList.remove("greenText");
        panelContents.classList.remove("redText");
        panelContents.classList.remove("whiteText");

        if (value > 0) {
            panelContents.classList.add("greenText");
        } else if (value === 0) {
            panelContents.classList.add("whiteText");
        } else {
            panelContents.classList.add("redText");
        }

        panelContents.classList.remove("smallText");
        panelContents.classList.add("largeText");

    }

    socket.on('dashboard', function(msg) {

        var nodeName = msg.nodeName;
        var action = msg.action;

        console.log(nodeName, action);

        if (msg.action === "connect") {
            console.log(msg.data);

            if (msg.data.added === true) {
                console.log("connected!");
                activatePanel(msg.data.nameNodeB, true);

            } else {
                console.log("disconnected!");
                activatePanel(msg.data.nameNodeB, false);

            }
        }

        if (msg.action === "update") {
            console.log("update!");
            console.log(msg.data);
            var panelContents = getPanelContents(nodeName);
            var frame = panelContents.firstChild;
            frame.contentWindow.postMessage({value: msg.data.value}, "http://localhost:3030");
        }

    });

    function createSidebarPanel(controlName) {
        var sidebarPanel = document.createElement("div");
        sidebarPanel.className = "sidebarPanel";
        sidebarPanel.id = controlName;

        var eventCaptureDiv = document.createElement('div');
        eventCaptureDiv.className = "eventCapture";
        sidebarPanel.appendChild(eventCaptureDiv);

        var centerContentsOuter = document.createElement("div");
        centerContentsOuter.className = "centerContentsOuter";
        sidebarPanel.appendChild(centerContentsOuter);

        var centerContentsInner = document.createElement("div");
        centerContentsInner.classList.add("centerContentsInner");
        centerContentsInner.classList.add("blue");
        centerContentsInner.classList.add("active");

        centerContentsOuter.appendChild(centerContentsInner);

        if (controlName === 'decimal') {
            var decimalFrame = createDecimalFrame();
            centerContentsInner.appendChild(decimalFrame);

        } else if (controlName === 'gauge') {
            var gaugeFrame = createGaugeFrame();
            centerContentsInner.appendChild(gaugeFrame);

        } else if (controlName === 'graph') {
            var graphFrame = createGraphFrame('debug');
            centerContentsInner.appendChild(graphFrame);

        } else if (controlName === 'light') {
            var lightFrame = createLightFrame();
            centerContentsInner.appendChild(lightFrame);

        } else {
            centerContentsInner.innerHTML = controlName;
        }

        return sidebarPanel;
    }

    function createDecimalFrame() {
        var decimalFrame = document.createElement('iframe');
        decimalFrame.classList.add('controlFrame');
        decimalFrame.id = 'decimalFrame';
        decimalFrame.src = "/frame_decimal.html";
        decimalFrame.scrolling = "no";
        decimalFrame.style.border = "0px solid transparent";
        decimalFrame.onload = function(e) {
            decimalFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return decimalFrame;
    }

    function createGaugeFrame() {
        var gaugeFrame = document.createElement('iframe');
        gaugeFrame.classList.add('controlFrame');
        gaugeFrame.id = 'gaugeFrame';
        gaugeFrame.src = "/frame_gauge.html";
        gaugeFrame.scrolling = "no";
        gaugeFrame.style.border = "0px solid transparent";
        gaugeFrame.onload = function(e) {
            gaugeFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return gaugeFrame;
    }

    function createGraphFrame(debug) {
        var graphFrame = document.createElement('iframe');
        graphFrame.classList.add('controlFrame');
        graphFrame.id = 'graphFrame';
        graphFrame.src = "/frame_graph.html";
        graphFrame.scrolling = "no";
        graphFrame.style.border = "0px solid transparent";
        graphFrame.onload = function(e) {
            graphFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
            if (debug) {
                graphFrame.contentWindow.postMessage({debug: true}, "http://localhost:3030");
            }
        };
        return graphFrame;
    }

    function createLightFrame() {
        var lightFrame = document.createElement('iframe');
        lightFrame.classList.add('controlFrame');
        lightFrame.id = 'lightFrame';
        lightFrame.src = "/frame_light.html";
        lightFrame.scrolling = "no";
        lightFrame.style.border = "0px solid transparent";
        lightFrame.onload = function(e) {
            lightFrame.contentWindow.postMessage({value: defaultValue}, "http://localhost:3030");
        };
        return lightFrame;
    }

    function createControlPanel(controls) {

//        startLoop();

        sidebar.style.width = "400px";
        sidebar.style.height = "1200px";

        controls.forEach( function(controlName) {
            var sidebarPanel = createSidebarPanel(controlName);
            sidebar.appendChild(sidebarPanel);
//            sidebarPanel.addEventListener('click', sidebarPanelClick);
        });

        var moreColumnsButton = document.createElement("button");
        moreColumnsButton.id = "moreColumns";
        moreColumnsButton.classList.add('button');
        moreColumnsButton.classList.add('blue');
        moreColumnsButton.classList.add('active');
        moreColumnsButton.innerHTML = "Columns +";
        moreColumnsButton.addEventListener('click', addColumn);
        sidebar.appendChild(moreColumnsButton);

        var fewerColumnsButton = document.createElement("button");
        fewerColumnsButton.id = "fewerColumns";
        fewerColumnsButton.classList.add('button');
        fewerColumnsButton.classList.add('blue');
        fewerColumnsButton.classList.add('active');
        fewerColumnsButton.innerHTML = "Columns -";
        fewerColumnsButton.addEventListener('click', removeColumn);
        sidebar.appendChild(fewerColumnsButton);

        sidebar.appendChild(document.createElement('br'));

        var moreRowsButton = document.createElement("button");
        moreRowsButton.id = "moreRows";
        moreRowsButton.classList.add('button');
        moreRowsButton.classList.add('blue');
        moreRowsButton.classList.add('active');
        moreRowsButton.innerHTML = "Rows +";
        moreRowsButton.addEventListener('click', addRow);
        sidebar.appendChild(moreRowsButton);

        var fewerRowsButton = document.createElement("button");
        fewerRowsButton.id = "fewerRows";
        fewerRowsButton.classList.add('button');
        fewerRowsButton.classList.add('blue');
        fewerRowsButton.classList.add('active');
        fewerRowsButton.innerHTML = "Rows -";
        fewerRowsButton.addEventListener('click', removeRow);
        sidebar.appendChild(fewerRowsButton);
    }

    function addColumn(e) {
        if (NUM_COLUMNS < MAX_COLUMNS) {
            NUM_COLUMNS++;
            socket.emit("addColumn");
        }
    }

    function removeColumn(e) {
        if (NUM_COLUMNS > MIN_COLUMNS) {
            NUM_COLUMNS--;
            socket.emit("removeColumn");
        }
    }

    function addRow(e) {
        if (NUM_ROWS < MAX_ROWS) {
            NUM_ROWS++;
            socket.emit("addRow");
        }
    }

    function removeRow(e) {
        if (NUM_ROWS > MIN_ROWS) {
            NUM_ROWS--;
            socket.emit("removeRow");
        }
    }

//    function sidebarPanelClick(e) {
//        console.log("clicked on sidebar panel", e);
//        console.log(e.currentTarget);
//
//        if (!currentlyDraggedPanel) {
//            var sidebarPanelClone = createSidebarPanel(e.currentTarget.id);
//            sidebarPanelClone.classList.add("region");
//            sidebarPanelClone.classList.add("smallText");
//            currentlyDraggedPanel = sidebarPanelClone;
//            document.getElementsByTagName('body')[0].appendChild(currentlyDraggedPanel);
//            sidebarPanelClone.classList.add("draggedPanel");
//        }
//    }

    function initializeDragInterface(exports) {

        // add event listeners for mouse down, up, move, (cancel?)

        document.addEventListener('mousedown', onMouseDown);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
//        document.addEventListener('mouseout', onMouseUpdate, false);

        var interactionState = getStates().NONE;

        function onMouseDown(e) {
            console.log("mousedown", interactionState);
            interactionState = performAction(getActions().MOUSE_DOWN, interactionState);
        }

        function onMouseMove(e) {
            console.log("mousemove", interactionState);
            mouseX = e.pageX;
            mouseY = e.pageY;
            interactionState = performAction(getActions().MOUSE_MOVE, interactionState);

            if (currentlyDraggedPanel) {
                currentlyDraggedPanel.style.top = mouseY + 20 + "px";
                currentlyDraggedPanel.style.left = mouseX + 20 + "px";
            }
        }

        function onMouseUp(e) {
            console.log("mouseup", interactionState);
            interactionState = performAction(getActions().MOUSE_UP, interactionState);
        }

        // maintain a state machine that triggers actions upon entering each state

        function getStates() {
            return {
                NONE: 0,
                CLICK: 1,
                HOLD: 3,
                DRAG: 5
            };
        }

        function getActions() {
            return {
                NONE: 0,
                MOUSE_DOWN: 1,
                MOUSE_MOVE: 2,
                MOUSE_UP: 3,
                MOUSE_CANCEL: 4,
                TIME_PASSED: 5
            };
        }

        function getEvents() {
            return {
                MOUSE_START_CLICK: 0,
                MOUSE_STOP_CLICK: 1,
                MOUSE_START_HOLD: 2,
                MOUSE_STOP_HOLD: 3,
                MOUSE_START_DRAG: 4,
                MOUSE_STOP_DRAG: 5
            };
        }

        function performAction(action, currentState) {

            if (action === getActions().MOUSE_DOWN) {
                if (currentState === getStates().NONE) {
                    triggerEvent(getEvents().MOUSE_START_CLICK);
                    return getStates().CLICK;
                }

            } else if (action === getActions().TIME_PASSED) {
                if (currentState === getStates().CLICK) {
                    triggerEvent(getEvents().MOUSE_START_HOLD);
                    return getStates().HOLD;
                }

            } else if (action === getActions().MOUSE_MOVE) {
                if (currentState === getStates().CLICK || currentState === getStates().HOLD) {
                    triggerEvent(getEvents().MOUSE_START_DRAG);
                    return getStates().DRAG;
                }

            } else if (action === getActions().MOUSE_UP || action === getActions().MOUSE_CANCEL) {
                if (currentState === getStates().CLICK) {
                    triggerEvent(getEvents().MOUSE_STOP_CLICK)
                } else if (currentState === getStates().HOLD) {
                    triggerEvent(getEvents().MOUSE_START_HOLD);
                } else if (currentState === getStates().DRAG) {
                    triggerEvent(getEvents().MOUSE_STOP_DRAG);
                }

                return getStates().NONE;

            }
            return currentState;
        }

        var timer;

        function triggerEvent(event) {
            clearTimeout(timer);
            switch (event) {
                case getEvents().MOUSE_START_CLICK:
                    console.log("keep track of what you clicked on");
                    startClick();
                    timer = setTimeout(function(){
                        interactionState = performAction(getActions().TIME_PASSED, interactionState);
                    }, 1000);
                    break;
                case getEvents().MOUSE_START_HOLD:
                    console.log("set clicked target as thing being held... show visual feedback");
                    startHoldOrDrag();
                    break;
                case getEvents().MOUSE_START_DRAG:
                    console.log("move held target to mouse position");
                    startHoldOrDrag();
                    break;
                case getEvents().MOUSE_STOP_CLICK:
                    console.log("trigger click event on whatever you were over");
                    break;
                case getEvents().MOUSE_STOP_HOLD:
                case getEvents().MOUSE_STOP_DRAG:
                    console.log("if holding anything, put it down where you are. assign held target to panel if possible.");
                    stopHoldOrDrag();
                    break;
                default:
                    console.log("shouldn't happen");
            }

            console.log("->", clickedPanelContainer, currentlyDraggedPanel);
        }

        var clickedPanelContainer = null;

        function startClick() {
            var clickedElement = document.elementFromPoint(mouseX,mouseY);//.parentElement.id
            if (clickedElement.className === 'eventCapture') {
                var parent = clickedElement.parentElement;
                console.log(parent.id);
                clickedPanelContainer = parent;
            } else {
                clickedPanelContainer = null;
            }

        }

        function startHoldOrDrag() {
            if (!currentlyDraggedPanel && clickedPanelContainer) {
                var sidebarPanelClone = createSidebarPanel(clickedPanelContainer.id);
                sidebarPanelClone.classList.add("region");
                sidebarPanelClone.classList.add("smallText");
                currentlyDraggedPanel = sidebarPanelClone;
                currentlyDraggedPanel.style.position = "absolute";
                document.getElementsByTagName('body')[0].appendChild(currentlyDraggedPanel);
                sidebarPanelClone.classList.add("draggedPanel");

                clickedPanelContainer = null;
            }
        }

        function stopHoldOrDrag() {
            if (currentlyDraggedPanel) {
                // get panel it's closest to or on top of
                var elementUnderMouse = document.elementFromPoint(mouseX,mouseY);//.parentElement.id
                if (elementUnderMouse.classList.contains("centerContentsInner")) {
                    var panel = elementUnderMouse.parentElement.parentElement;
                    if (panel) {
                        console.log('released on panel');
                        panelVisualizationTypes[panel.id] = currentlyDraggedPanel.id;
                        setPanelDisplay(panel, currentlyDraggedPanel.id);
                    }
                }
                document.getElementsByTagName('body')[0].removeChild(currentlyDraggedPanel);
                currentlyDraggedPanel = null;
            }
        }
    }

//    function startLoop() {
//        setInterval(function () {
//            if (currentlyDraggedPanel) {
////                currentlyDraggedPanel.style.left = mouseX;
////                currentlyDraggedPanel.style.top = mouseY;
////                console.log(currentlyDraggedPanel);
////                console.log('moved to ', currentlyDraggedPanel.style.left, currentlyDraggedPanel.style.top);
//
//                currentlyDraggedPanel.style.position = "absolute";
//
////                console.log( mouseY - (mouseY - currentlyDraggedPanel.offsetTop) + "px" );
////                console.log(mouseX, mouseY);
//
//                currentlyDraggedPanel.style.top = mouseY + 20 + "px"; //mouseY - (mouseY - currentlyDraggedPanel.offsetTop) + "px";
//                currentlyDraggedPanel.style.left = mouseX + 20 + "px"; //mouseX - (mouseX - currentlyDraggedPanel.offsetLeft) + "px";
//            }
//        }, 16.67);
//    }
//
//    function onMouseUpdate(e) {
//        mouseX = e.pageX;
//        mouseY = e.pageY;
////        console.log('mouse moved', mouseX, mouseY);
//    }
//
//    function clickedOnPanel(panel) {
//
//        if (currentlyDraggedPanel) {
//            console.log('clicked on panel');
//
//            setPanelDisplay(panel, currentlyDraggedPanel.id);
//
////        activatePanel(panel.id, !getPanelContents(panel.id).classList.contains("active"));
//
//            document.getElementsByTagName('body')[0].removeChild(currentlyDraggedPanel);
//            currentlyDraggedPanel = null;
//        }
//
//    }

    var widthPercentage = 0.9;
    var heightToWidthRatio = 0.5;

    function setPanelDisplay(panel, controlName) {

        getPanelContents(panel.id).innerHTML = "";
        var frame;

        if (controlName === "decimal") {
            frame = createDecimalFrame();

        } else if (controlName === "gauge") {
            frame = createGaugeFrame();

        } else if (controlName === "graph") {
            frame = createGraphFrame();

        } else if (controlName === "light") {
            frame = createLightFrame();
        }

        frame.style.width = (getPanelContents(panel.id).clientWidth * widthPercentage) + "px";
        frame.style.height = (getPanelContents(panel.id).clientHeight * widthPercentage * heightToWidthRatio) + "px";

        getPanelContents(panel.id).appendChild(frame);
    }

</script>
</body>
</html>
