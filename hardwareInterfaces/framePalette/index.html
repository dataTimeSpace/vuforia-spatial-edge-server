<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Frame Palette</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>

<div id="sidebar" class="region blue smallText">Control Panel</div>
<div class="paletteMarker"></div>

<script src="/socket.io/socket.io.js"></script>

<script>

    var sidebar = document.getElementById("sidebar");
    var socket = io();

    // constants
    var defaultValue = 0.00;

    // variables for drag interface
    var currentlyDraggedPanel = null;

    // variables for screen <-> AR transition
    var arFrameState = {
        flipThreshold: 1000,
        x: 0,
        y: 0,
        isInScreen: true
    };

    window.onload = function() {
        createControlPanel(["decimal", "gauge", "graph", "light"]);
        initializeDragInterface();

        socket.on('remoteTouchDown', function(msg) {
            // console.log('remoteTouchDown', msg);
            simulateMouseEvent(msg.pageX, msg.pageY, 'mousedown');
        });

        socket.on('remoteTouchMove', function(msg) {
            // console.log('remoteTouchMove', msg);
            simulateMouseEvent(msg.pageX, msg.pageY, 'mousemove');
        });

        socket.on('remoteTouchUp', function(msg) {
            console.log('remoteTouchUp', msg);
            arFrameState.isInScreen = true;
            simulateMouseEvent(msg.pageX, msg.pageY, 'mouseup');
        });

        socket.on('zWhilePointerDown', function(msg) {
            var zPosition = msg.zPosition;

            // console.log('1');

            if (currentlyDraggedPanel) {

                // console.log('2');

                var draggedPanelX = parseInt(currentlyDraggedPanel.style.left);
                var draggedPanelY = parseInt(currentlyDraggedPanel.style.top);

                var frameType = currentlyDraggedPanel.id;

                // console.log('xPosition: ' + draggedPanelX, 'yPosition: ' + draggedPanelY, 'zPosition: ' + zPosition);

                var msgData = {
                    destination: 'ar',
                    xPosition: draggedPanelX,
                    yPosition: draggedPanelY,
                    zPosition: zPosition,
                    frameData: {
                        uniqueName: frameType + uuidTime(),
                        type: frameType
                    }
                };

                if (arFrameState.isInScreen) {

                    // console.log('3');

                    if (zPosition > arFrameState.flipThreshold) {

                        console.log('send to 3D');

                        // hide the 2D frame on the hardware interface and display a 3D frame in the editor
                        // making sure to set the 3D frame to the correct position
                        currentlyDraggedPanel.style.opacity = 0.5;

                        socket.emit('transportFrame', msgData);

                        arFrameState.isInScreen = false;

                    }

                } else {

                    if (zPosition < arFrameState.flipThreshold) {

                        console.log('send to 2D');

                        // hide the 3D frame in the editor and show the 2D frame on the hardware interface
                        // making sure to set the 2D frame to the correct position
                        currentlyDraggedPanel.style.opacity = 1;

                        msgData.destination = 'screen';

                        socket.emit('transportFrame', msgData);

                        arFrameState.isInScreen = true;

                    }

                }

            }

        });

    };

    function createControlPanel(controls) {

        sidebar.style.width = "400px";
        sidebar.style.height = "1200px";

        controls.forEach( function(controlName) {
            var sidebarPanel = createSidebarPanel(controlName);
            sidebar.appendChild(sidebarPanel);
        });
    }

    function createSidebarPanel(controlName) {
        var sidebarPanel = document.createElement("div");
        sidebarPanel.className = "sidebarPanel";
        sidebarPanel.id = controlName;

        var eventCaptureDiv = document.createElement('div');
        eventCaptureDiv.className = "eventCapture";
        sidebarPanel.appendChild(eventCaptureDiv);

        var centerContentsOuter = document.createElement("div");
        centerContentsOuter.className = "centerContentsOuter";
        sidebarPanel.appendChild(centerContentsOuter);

        var centerContentsInner = document.createElement("div");
        centerContentsInner.classList.add("centerContentsInner");
        centerContentsInner.classList.add("blue");
        centerContentsInner.classList.add("active");

        centerContentsOuter.appendChild(centerContentsInner);

        var frame = createFrame(controlName);
        centerContentsInner.appendChild(frame);

        return sidebarPanel;
    }

    function createFrame(frameType) {
        var frameDomElement = document.createElement('iframe');
        frameDomElement.classList.add('controlFrame');
        frameDomElement.frameType = frameType;
        frameDomElement.id = frameType + 'Frame';
        frameDomElement.src = '/frames/' + frameType + '.html';
        frameDomElement.scrolling = 'no';
        frameDomElement.style.border = '0px solid transparent';
        frameDomElement.onload = function() {
            frameDomElement.contentWindow.postMessage({value: defaultValue}, 'http://localhost:3032'); // TODO: change localhost in production?
        };
        return frameDomElement;
    }

    function simulateMouseEvent(x,y,eventName) {
        mouseX = x * 2.0;
        mouseY = y * 2.0;

        var ev = new MouseEvent(eventName, {
            'view': window,
            'bubbles': true,
            'cancelable': true,
            'screenX': x,
            'screenY': y
        });
        ev.simulated = true;

        var el = document.elementFromPoint(x, y);
        el.dispatchEvent(ev);
    }

    function initializeDragInterface() {

        var timer;
        var clickedPanelContainer = null;

        // add event listeners for mouse down, up, move, (cancel?)

        document.addEventListener('mousedown', onMouseDown);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
//        document.addEventListener('mouseout', onMouseUpdate, false);

        var interactionState = getStates().NONE;

        function onMouseDown(e) {
            console.log("mousedown", interactionState);
            interactionState = performAction(getActions().MOUSE_DOWN, interactionState);
        }

        function onMouseMove(e) {
            // console.log("mousemove", interactionState);

            // remote touch came from phone
            if (e.simulated) {
                mouseX = e.screenX * 2.0;
                mouseY = e.screenY * 2.0;
            } else {
                mouseX = e.pageX;
                mouseY = e.pageY;
            }

            interactionState = performAction(getActions().MOUSE_MOVE, interactionState);

            // console.log(currentlyDraggedPanel);
            if (currentlyDraggedPanel) {
                currentlyDraggedPanel.style.top = mouseY + dragOffsetY + "px"; // + 20
                currentlyDraggedPanel.style.left = mouseX + dragOffsetX + "px"; // + 20
            }
        }

        function onMouseUp(e) {
            console.log("mouseup", interactionState);
            interactionState = performAction(getActions().MOUSE_UP, interactionState);
        }

        // maintain a state machine that triggers actions upon entering each state

        function getStates() {
            return {
                NONE: 0,
                CLICK: 1,
                HOLD: 3,
                DRAG: 5
            };
        }

        function getActions() {
            return {
                NONE: 0,
                MOUSE_DOWN: 1,
                MOUSE_MOVE: 2,
                MOUSE_UP: 3,
                MOUSE_CANCEL: 4,
                TIME_PASSED: 5
            };
        }

        function getEvents() {
            return {
                MOUSE_START_CLICK: 0,
                MOUSE_STOP_CLICK: 1,
                MOUSE_START_HOLD: 2,
                MOUSE_STOP_HOLD: 3,
                MOUSE_START_DRAG: 4,
                MOUSE_STOP_DRAG: 5
            };
        }

        function performAction(action, currentState) {

            if (action === getActions().MOUSE_DOWN) {
                if (currentState === getStates().NONE) {
                    triggerEvent(getEvents().MOUSE_START_CLICK);
                    return getStates().CLICK;
                }

            } else if (action === getActions().TIME_PASSED) {
                if (currentState === getStates().CLICK) {
                    triggerEvent(getEvents().MOUSE_START_HOLD);
                    return getStates().HOLD;
                }

            } else if (action === getActions().MOUSE_MOVE) {
                if (currentState === getStates().CLICK || currentState === getStates().HOLD) {
                    triggerEvent(getEvents().MOUSE_START_DRAG);
                    return getStates().DRAG;
                }

            } else if (action === getActions().MOUSE_UP || action === getActions().MOUSE_CANCEL) {
                if (currentState === getStates().CLICK) {
                    triggerEvent(getEvents().MOUSE_STOP_CLICK)
                } else if (currentState === getStates().HOLD) {
                    triggerEvent(getEvents().MOUSE_START_HOLD);
                } else if (currentState === getStates().DRAG) {
                    triggerEvent(getEvents().MOUSE_STOP_DRAG);
                }

                return getStates().NONE;

            }
            return currentState;
        }

        function triggerEvent(event) {
            clearTimeout(timer);
            switch (event) {
                case getEvents().MOUSE_START_CLICK:
                    startClick();
                    timer = setTimeout(function(){
                        interactionState = performAction(getActions().TIME_PASSED, interactionState);
                    }, 1000);
                    break;
                case getEvents().MOUSE_START_HOLD:
                    startHoldOrDrag();
                    break;
                case getEvents().MOUSE_START_DRAG:
                    startHoldOrDrag();
                    break;
                case getEvents().MOUSE_STOP_CLICK:
                    break;
                case getEvents().MOUSE_STOP_HOLD:
                case getEvents().MOUSE_STOP_DRAG:
                    stopHoldOrDrag();
                    break;
                default:
                    console.log("shouldn't happen");
            }
        }

        function startClick() {
            clickedPanelContainer = null;
            var allDivsHere = getAllDivsUnderCoordinate(mouseX, mouseY);
            allDivsHere.some( function(clickedElement) {
                if (clickedElement.classList.contains('sidebarPanel')) {
                    clickedPanelContainer = clickedElement;
                    dragOffsetX = clickedPanelContainer.getBoundingClientRect().x - mouseX;
                    dragOffsetY = clickedPanelContainer.getBoundingClientRect().y - mouseY;
                }
                return (!!clickedPanelContainer);
            });
        }

        function startHoldOrDrag() {
            if (!currentlyDraggedPanel && clickedPanelContainer) {
                var sidebarPanelClone = createSidebarPanel(clickedPanelContainer.id);
                sidebarPanelClone.classList.add("region");
                sidebarPanelClone.classList.add("smallText");
                currentlyDraggedPanel = sidebarPanelClone;
                currentlyDraggedPanel.style.position = "absolute";
                document.getElementsByTagName('body')[0].appendChild(currentlyDraggedPanel);
                sidebarPanelClone.classList.add("draggedPanel");
                clickedPanelContainer = null;
            }
        }

        function stopHoldOrDrag() {
            if (currentlyDraggedPanel) {
                // get panel it's on top of
                var allDivsHere = getAllDivsUnderCoordinate(mouseX, mouseY);
                allDivsHere.forEach( function(element) {
                    if (element.classList.contains('region') &&  element.id.startsWith('panel_') && element.id !== 'panel_row0_col0') {
                        console.log('released on panel');
                        panelVisualizationTypes[element.id] = currentlyDraggedPanel.id;
                        setPanelDisplay(element, currentlyDraggedPanel.id);
                    }
                });

                document.getElementsByTagName('body')[0].removeChild(currentlyDraggedPanel);
                currentlyDraggedPanel = null;
            }
        }

        function getAllDivsUnderCoordinate(x, y) {
            var res = [];

            var ele = document.elementFromPoint(x,y);
            while(ele && ele.tagName !== "BODY" && ele.tagName !== "HTML"){
                res.push(ele);
                ele.style.display = "none";
                ele = document.elementFromPoint(x,y);
            }

            for(var i = 0; i < res.length; i++){
                res[i].style.display = "";  // TODO: more correct if you set back to original display type
            }
            console.log(res);
            return res;
        }
    }

    // ..... UTILITIES ..... //

    // copied from userinterface realityEditor.device.utilities.uuidTime
    function uuidTime() {
        var dateUuidTime = new Date();
        var abcUuidTime = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var stampUuidTime = parseInt(Math.floor((Math.random() * 199) + 1) + "" + dateUuidTime.getTime()).toString(36);
        while (stampUuidTime.length < 12) stampUuidTime = abcUuidTime.charAt(Math.floor(Math.random() * abcUuidTime.length)) + stampUuidTime;
        return stampUuidTime;
    }

</script>

</body>
</html>
