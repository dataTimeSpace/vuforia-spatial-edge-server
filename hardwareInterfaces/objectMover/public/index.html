<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Object Mover</title>
    <style>
        body {
            margin: 10px;
        }
        div {
            margin-bottom: 10px;
        }
        #title {
            font-weight: bold;
        }
        #drawing01 {
            position: absolute;
            left: -150px;
            top: 850px;
            width: 300px;
            height: 300px;
            /*transform: scale(0.4);*/
            pointer-events: none;
        }
        #drawing10 {
            position: absolute;
            left: 850px;
            top: -150px;
            width: 300px;
            height: 300px;
            /*transform: scale(0.4);*/
            pointer-events: none;
        }
    </style>
</head>
<body>
<script src="/socket.io/socket.io.js"></script>

<div id="container">
    <div id="title">
        Object Mover
    </div>
    <div id="dropdownContainer"></div>
    <div>
        X Offset: <input type="number" id="xOffsetField" value="0">
    </div>
    <div>
        Y Offset: <input type="number" id="yOffsetField" value="0">
    </div>
    <div>
        Z Offset: <input type="number" id="zOffsetField" value="0">
    </div>
    <div>
        Rotation: <input type="number" id="rotationField" value="0">
    </div>
<!--    <div>-->
<!--        Matrix: <textarea type="text" id="matrixTextField">[0.841218,-0.013899,0.540517,0,0.050835,0.997275,-0.053472,0,-0.538301,0.072459,0.839632,0,-271.7233889999999,116.11174,-2338.165527000001,1]</textarea>-->
<!--    </div>-->
    <input type="button" value="Reset" id="resetButton">
    <input type="button" value="Submit" id="submitButton">
    <input type="button" value="Stream On" id="streamOnButton">
    <input type="button" value="Stream Off" id="streamOffButton">

    <input type="button" value="Debug" id="debugButton">
    
    <input type="button" value="Both" id="both">
    <input type="button" value="Second Only" id="secondOnly">
    <input type="button" value="First Only" id="firstOnly">
    <input type="button" value="None" id="none">

    <iframe id='drawing01' src="http://localhost:8080/obj/drawing01/frames/default01/"></iframe>
    <iframe id='drawing10' src="http://localhost:8080/obj/drawing10/frames/default10/"></iframe>
</div>

<script>
    var xOffsetField = document.getElementById('xOffsetField');
    var yOffsetField = document.getElementById('yOffsetField');
    var zOffsetField = document.getElementById('zOffsetField');
    var rotationField = document.getElementById('rotationField');
    // var matrixTextField = document.getElementById('matrixTextField');
    var submitButton = document.getElementById('submitButton');
    var streamOnButton = document.getElementById('streamOnButton');
    var streamOffButton = document.getElementById('streamOffButton');

    var debugButton = document.getElementById('debugButton');
    var both = document.getElementById('both');
    var secondOnly = document.getElementById('secondOnly');
    var firstOnly = document.getElementById('firstOnly');
    var none = document.getElementById('none');
    
    xOffsetField.addEventListener('keyup', xChanged);
    xOffsetField.addEventListener('change', xChanged);
    yOffsetField.addEventListener('keyup', yChanged);
    yOffsetField.addEventListener('change', yChanged);
    zOffsetField.addEventListener('keyup', zChanged);
    zOffsetField.addEventListener('change', zChanged);
    rotationField.addEventListener('keyup', rotationChanged);
    rotationField.addEventListener('change', rotationChanged);
    // matrixTextField.addEventListener('keyup', matrixChanged);
    resetButton.addEventListener('click', resetMatrix);
    submitButton.addEventListener('click', matrixChanged);
    streamOnButton.addEventListener('click', streamOn);
    streamOffButton.addEventListener('click', streamOff);
    document.addEventListener('mousemove', onPointerMove);
    // var defaultMatrix = "[0.841218,-0.013899,0.540517,0,0.050835,0.997275,-0.053472,0,-0.538301,0.072459,0.839632,0,-271.7233889999999,116.11174,-2338.165527000001,1]";
    // var defaultMatrix = '[0.9999010560091449,0.01203435538199682,-0.007265124494630683,0,-0.011959516021826377,0.9998757167509125,0.010281784874970532,0,0.007387583011282801,-0.010193258515928729,0.9999199474424679,0,989.0695336846786,-33.02772389802351,42.77521617565003,1]' // drawing10 matrix
    var defaultMatrix = '[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]';
    var defaultObjectKey = 'stoneTestrmix4u3rq5ve';
    var editorId = 'testid01';

    // matrixTextField.innerText = defaultMatrix;

    var allObjectKeys = [];
    
    var socket = io();
    socket.on('allObjects', function(e) {
        console.log('allObjects', e);
        allObjectKeys = Object.keys(e);
        
        // create dropdown for objects
        var dropdown = document.createElement('select');
        dropdown.id = 'dropdown';
        allObjectKeys.forEach(function(discoveredObjectKey) {
            var isDefault = discoveredObjectKey === defaultObjectKey;
            dropdown.options.add(new Option(discoveredObjectKey, discoveredObjectKey, isDefault, isDefault));
        });
        document.getElementById('dropdownContainer').appendChild(dropdown);
    });
    socket.emit('getAllObjects', null);

    var serverSocket = io.connect('http://localhost:8080');
    serverSocket.on('connect', function() {
        console.log('connected to server socket');
    });
    
    function xChanged(event) {
        var value = parseFloat(event.target.value) || 0;
        console.log('x', value);
        socket.emit('newX', value);
        matrixChanged();
    }
    
    function yChanged(event) {
        var value = parseFloat(event.target.value) || 0;
        console.log('y', value);
        socket.emit('newY', value);
        matrixChanged();
    }

    function zChanged(event) {
        var value = parseFloat(event.target.value) || 0;
        console.log('z', value);
        socket.emit('newZ', value);
        matrixChanged();
    }
    
    function rotationChanged(event) {
        var value = parseFloat(event.target.value) || 0;
        console.log('rotation', value);
        socket.emit('newRotation', value);
        matrixChanged();
    }
    
    function getXOffset() {
        return parseFloat(xOffsetField.value) || 0;
    }
    
    function getYOffset() {
        return parseFloat(yOffsetField.value) || 0;
    }
    
    function getZOffset() {
        return parseFloat(zOffsetField.value) || 0;
    }
    
    function getRotationRadians() {
        var degrees = parseFloat(rotationField.value) || 0;
        return (degrees / 180) * Math.PI;
    }
    
    function getSelectedObjectKey() {
        return document.getElementById('dropdown').value || defaultObjectKey;
    }
    
    function resetMatrix() {
        xOffsetField.value = 0;
        yOffsetField.value = 0;
        zOffsetField.value = 0;
        rotationField.value = 0;
        // matrixTextField.value = defaultMatrix;
        matrixChanged();
    }
    
    function matrixChanged() {
        // var matrixArray = JSON.parse(matrixTextField.value);
        // matrixArray[12] += getXOffset() * 10;
        // matrixArray[13] += getYOffset() * 10;
        
        var rotationMatrix = [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];
        var radians = getRotationRadians();
        rotationMatrix[0] = Math.cos(radians);
        rotationMatrix[1] = -Math.sin(radians);
        rotationMatrix[4] = Math.sin(radians);
        rotationMatrix[5] = Math.cos(radians);
        
        rotationMatrix[12] = getXOffset();
        rotationMatrix[13] = getYOffset();
        rotationMatrix[14] = getZOffset();

        // matrixTextField.value = JSON.stringify(rotationMatrix);
        
        var selectedObjectKey = getSelectedObjectKey();
        
        if (serverSocket) {
            // var messageBody = {
            //     objectKey: selectedObjectKey,
            //     matrix: rotationMatrix, //matrixArray,
            //     editorId: editorId
            // };
            // serverSocket.emit('/update/object/matrix', JSON.stringify(messageBody));

            var messageBody = {
                objectKey: selectedObjectKey,
                position: {
                    x: getXOffset(),
                    y: getYOffset(),
                    z: getZOffset()
                },
                rotationInRadians: getRotationRadians(),
                editorId: 'testID'
            };
            serverSocket.emit('/update/object/position', JSON.stringify(messageBody));
        }
    }
    
    var isStreamOn = false;
    function streamOff() {
        isStreamOn = false;
    }
    function streamOn() {
        isStreamOn = true;
    }
    
    function onPointerMove(event) {
        if (isStreamOn) {
            var x = event.pageX;
            var y = event.pageY;

            var selectedObjectKey = getSelectedObjectKey();

            if (serverSocket) {
                var messageBody = {
                    objectKey: selectedObjectKey,
                    position: {
                        x: x,
                        y: y,
                        z: 0
                    },
                    rotationInRadians: getRotationRadians(),
                    editorId: 'testID'
                };
                serverSocket.emit('/update/object/position', JSON.stringify(messageBody));
            }
        }
    }
    
    var DEBUG = false;
    var suffix = DEBUG ? '_debug' : '';
    var perturbation = 0.01;

    debugButton.addEventListener('click', function(e) {
        if (serverSocket) {
            // var messageBody = [{id: 0, joints: [{x: 1, y: 2, z: 3}, {x: 4, y: 5, z: 6}, ... (32 entries)]}, {id: 1, joints: [{x: 7, y: 8, z: 9}, {x: 10, y: 11, z: 12}, ... (32 entries)]
            // var messageBody = [];
            // messageBody.push(newPoseEntry(0));
            // messageBody.push(newPoseEntry(1));
            var messageBody = perturbPoses(newPoseEntry(), perturbation);
            console.log(messageBody);
            serverSocket.emit('/update/humanPoses'+suffix, JSON.stringify(messageBody));
        }
    });

    none.addEventListener('click', function(e) {
        if (serverSocket) {
            var messageBody = [];
            console.log(messageBody);
            serverSocket.emit('/update/humanPoses'+suffix, JSON.stringify(messageBody));
        }
    });
    
    both.addEventListener('click', function(e) {
        if (serverSocket) {
            var messageBody = [];
            messageBody.push(pose(1, 0));
            messageBody.push(pose(2, 2));
            messageBody = perturbPoses(messageBody, perturbation);
            console.log(messageBody);
            serverSocket.emit('/update/humanPoses'+suffix, JSON.stringify(messageBody));
        }
    });

    firstOnly.addEventListener('click', function(e) {
        if (serverSocket) {
            var messageBody = [];
            messageBody.push(pose(1, 0));
            messageBody = perturbPoses(messageBody, perturbation);
            console.log(messageBody);
            serverSocket.emit('/update/humanPoses'+suffix, JSON.stringify(messageBody));
        }
    });

    secondOnly.addEventListener('click', function(e) {
        if (serverSocket) {
            var messageBody = [];
            messageBody.push(pose(2, 2));
            messageBody = perturbPoses(messageBody, perturbation);
            console.log(messageBody);
            serverSocket.emit('/update/humanPoses'+suffix, JSON.stringify(messageBody));
        }
    });
    
    function pose(id, xOffset) {
        var thisPose = {
            "id": id,
            "joints":[{"x":-2.85808753967285,"y":1.09325528144836,"z":1.86841201782227},{"x":-2.88649940490723,"y":1.28932952880859,"z":1.874720454216},{"x":-2.9052848815918,"y":1.44648587703705,"z":1.88254809379578},{"x":-2.91767024993896,"y":1.68731904029846,"z":1.88830482959747},{"x":-2.89380407333374,"y":1.65015554428101,"z":1.90425324440002},{"x":-2.73518109321594,"y":1.64421701431274,"z":1.90979313850403},{"x":-2.59784317016602,"y":1.37169241905212,"z":1.94355845451355},{"x":-2.46968936920166,"y":1.2962589263916,"z":1.73309445381165},{"x":-2.45180678367615,"y":1.32216215133667,"z":1.63084101676941},{"x":-2.35400819778442,"y":1.26007270812988,"z":1.59931862354279},{"x":-2.42386150360107,"y":1.25834238529205,"z":1.58319044113159},{"x":-2.94943594932556,"y":1.64581489562988,"z":1.89379620552063},{"x":-3.07334184646606,"y":1.6096978187561,"z":1.82528829574585},{"x":-3.13171124458313,"y":1.30607533454895,"z":1.77755284309387},{"x":-2.98326969146729,"y":1.34714078903198,"z":1.5668888092041},{"x":-2.87338900566101,"y":1.34909844398499,"z":1.6014244556427},{"x":-2.93799495697021,"y":1.41435360908508,"z":1.52730488777161},{"x":-2.82947373390198,"y":1.40204799175262,"z":1.54997944831848},{"x":-2.76111936569214,"y":1.1064635515213,"z":1.89461135864258},{"x":-2.68932175636292,"y":0.668614268302917,"z":1.86327600479126},{"x":-2.64878392219543,"y":0.253593683242798,"z":1.94585204124451},{"x":-2.58115911483765,"y":0.103814959526062,"z":1.81810688972473},{"x":-2.94552707672119,"y":1.08134162425995,"z":1.84478569030762},{"x":-2.93494749069214,"y":0.637665510177612,"z":1.86629295349121},{"x":-2.98301076889038,"y":0.23420786857605,"z":2.00571250915527},{"x":-2.87934303283691,"y":0.0808491706848145,"z":1.95662999153137},{"x":-2.9167206287384,"y":1.77221739292145,"z":1.85623002052307},{"x":-2.88282299041748,"y":1.82121288776398,"z":1.68792676925659},{"x":-2.84897303581238,"y":1.85563611984253,"z":1.72712755203247},{"x":-2.81039333343506,"y":1.84990763664246,"z":1.86247324943542},{"x":-2.92399954795837,"y":1.85568761825562,"z":1.70843195915222},{"x":-3.01743745803833,"y":1.85042190551758,"z":1.81993818283081}]
        };
        
        thisPose.joints.forEach(function(jointPos) {
            jointPos.x += xOffset;
        });
        
        return thisPose;
    }




    function perturbPoses(poses, percent) {
        poses.forEach(function(poseEntry) {
            poseEntry.joints.forEach(function(jointPos) {
                jointPos.x += (Math.random()-0.5) * percent;
                jointPos.y += (Math.random()-0.5) * percent;
                jointPos.z += (Math.random()-0.5) * percent;
            });
        });
        return poses;
    }
    
    function newPoseEntry(_id) {
        return [
            {
                "id":2,
                "joints":[{"x":-2.85808753967285,"y":1.09325528144836,"z":1.86841201782227},{"x":-2.88649940490723,"y":1.28932952880859,"z":1.874720454216},{"x":-2.9052848815918,"y":1.44648587703705,"z":1.88254809379578},{"x":-2.91767024993896,"y":1.68731904029846,"z":1.88830482959747},{"x":-2.89380407333374,"y":1.65015554428101,"z":1.90425324440002},{"x":-2.73518109321594,"y":1.64421701431274,"z":1.90979313850403},{"x":-2.59784317016602,"y":1.37169241905212,"z":1.94355845451355},{"x":-2.46968936920166,"y":1.2962589263916,"z":1.73309445381165},{"x":-2.45180678367615,"y":1.32216215133667,"z":1.63084101676941},{"x":-2.35400819778442,"y":1.26007270812988,"z":1.59931862354279},{"x":-2.42386150360107,"y":1.25834238529205,"z":1.58319044113159},{"x":-2.94943594932556,"y":1.64581489562988,"z":1.89379620552063},{"x":-3.07334184646606,"y":1.6096978187561,"z":1.82528829574585},{"x":-3.13171124458313,"y":1.30607533454895,"z":1.77755284309387},{"x":-2.98326969146729,"y":1.34714078903198,"z":1.5668888092041},{"x":-2.87338900566101,"y":1.34909844398499,"z":1.6014244556427},{"x":-2.93799495697021,"y":1.41435360908508,"z":1.52730488777161},{"x":-2.82947373390198,"y":1.40204799175262,"z":1.54997944831848},{"x":-2.76111936569214,"y":1.1064635515213,"z":1.89461135864258},{"x":-2.68932175636292,"y":0.668614268302917,"z":1.86327600479126},{"x":-2.64878392219543,"y":0.253593683242798,"z":1.94585204124451},{"x":-2.58115911483765,"y":0.103814959526062,"z":1.81810688972473},{"x":-2.94552707672119,"y":1.08134162425995,"z":1.84478569030762},{"x":-2.93494749069214,"y":0.637665510177612,"z":1.86629295349121},{"x":-2.98301076889038,"y":0.23420786857605,"z":2.00571250915527},{"x":-2.87934303283691,"y":0.0808491706848145,"z":1.95662999153137},{"x":-2.9167206287384,"y":1.77221739292145,"z":1.85623002052307},{"x":-2.88282299041748,"y":1.82121288776398,"z":1.68792676925659},{"x":-2.84897303581238,"y":1.85563611984253,"z":1.72712755203247},{"x":-2.81039333343506,"y":1.84990763664246,"z":1.86247324943542},{"x":-2.92399954795837,"y":1.85568761825562,"z":1.70843195915222},{"x":-3.01743745803833,"y":1.85042190551758,"z":1.81993818283081}]
            }
        ];
    }

    // function newJoint() {
    //     return {
    //         x: Math.random() * 10,
    //         y: Math.random() * 10,
    //         z: Math.random()
    //     }
    // }
    // function newPoseEntry(id) {
    //     var joints = [];
    //     for (var i = 0; i < 32; i++) {
    //         joints.push(newJoint());
    //     }
    //     return {
    //         id: id,
    //         joints: joints
    //     }
    // }
    
</script>
</body>
</html>
