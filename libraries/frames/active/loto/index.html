<!DOCTYPE html>
<html lang="en">
<head>
    <script src="objectDefaultFiles/object.js"></script>
    <script src="objectDefaultFiles/pep.min.js"></script>
    <meta charset="UTF-8">
    <title>LOTO Step</title>
    <style>
        @font-face {
            font-family: 'Brutal Type';
            src: url('resources/brutal/BrutalType.otf');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Brutal Type';
            src: url('resources/brutal/BrutalType-Bold.otf');
            font-weight: bold;
            font-style: normal;
        }
        body {
            font-family: "Brutal Type", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        .block {
            width: 200px;
            height: 200px;
            border: 10px solid white;
            color: white;
            background-color: rgba(0,0,0,0.7);
            position: absolute;
            margin: 0;
            padding: 0;
            text-align: center;
            line-height: 190px;
            font-size: 60px;
            box-sizing: border-box;
            border-radius: 5px;
            white-space: nowrap;
        }
        .blockSvg {
            width: 200px;
            height: 200px;
            /*border: 10px solid white;*/
            color: white;
            background-color: rgba(0,0,0,0.7);
            position: absolute;
            margin: 0;
            padding: 0;
            text-align: center;
            line-height: 190px;
            font-size: 60px;
            box-sizing: border-box;
            /*border-radius: 5px;*/
        }
        .small {
            width: 120px;
            height: 120px;
            line-height: 110px;
        }
        .sleek {
            border-width: 0;
            color: white;
        }
        .twoLine {
            font-size: 40px;
            line-height: 50px !important;
        }
        #topLeft {
            left: 0;
            top: 0;
        }
        #topRight {
            left: 220px;
            top: 0;
        }
        #bottomLeft {
            left: 0;
            top: 220px;
        }
        #bottomRight {
            left: 220px;
            top: 220px;
        }
        #locator {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 5px solid #ff4365;
            background-color: #ff436588;
            box-sizing: border-box;
        }
        #lotoImage {
            position: absolute;
            width: 200px;
            height: 200px;
            left: 0;
            top: 440px;
        }
        #completedImage {
            position: absolute;
            width: 200px;
            height: 200px;
            left: 0;
            top: 440px;
        }
        .recording {
            color: red !important;
        }
        #recordedVideo {
            display: inline;
            position: absolute;
            left: 440px;
            top: 0;
            width: 782px;
            height: 440px;
        }
        #videoImage {
            display: inline;
            position: absolute;
            left: 440px;
            top: 0;
            width: 782px;
            height: 440px;
        }
        .videoHidden {
            display: none !important;
        }
        .videoRecordIcon {
            width: 120px;
            height: 120px;
            left: 40px;
            top: 40px;
            position: absolute;
        }
    </style>
</head>

<body style="margin: 0; width: 860px; height: 560px">
    <div id="container"></div>
    <div id="videoContainer">
        <div id="videoSrc" class="videoHidden">
            <video id="recordedVideo" width="782" height="440" playsinline webkit-playsinline>
                <source id="source">
            </video>
        </div>
    </div>
</body>

<script>
    var container = document.getElementById('container');
    var recordedVideo = document.querySelector('#recordedVideo');
    var isDangerTypeConfigured = false;
    var isDangerValueConfigured = true; // right now I'm counting it as configured even if you haven't entered a value
    var isEquipmentConfigured = true; // configured by default because UI to change it is not in this version
    
    var dangerType = undefined;
    var dangerValue = undefined;
    
    var numLocks = 1;
    var numTags = 1;
    
    var stepNumber = 1;
    var dangerTypeNumber = 1;
    
    var videoPath = null;
    var isVideoRecording = false;
    var isVideoLoaded = false;
    var isVideoPlaying = false;
    
    var InterfaceStates = Object.freeze({
        COLLAPSED: 0,
        EXPANDED_EDITABLE: 1,
        SET_DANGER_TYPE: 2,
        SET_DANGER_VALUE: 3,
        SET_EQUIPMENT: 4,
        EXPANDED_PLAYBACK: 5,
        HIDDEN: 6,
        COMPLETED: 7,
        RECORDING: 8
    });
    
    var DangerTypes = Object.freeze({
        ELECTRIC: 0,
        WATER: 1,
        GAS: 2,
        PNEUMATIC: 3
    });
    
    var currentInterfaceState = InterfaceStates.COLLAPSED;
    
    var sessionFrameId;

    var realityInterface = new RealityInterface();
    
    var isEditable = true;
    var isCompleted = false;
    
    var isScreenPositionListenerRegistered = false;
    var mostRecentScreenPosition = null;

    var currentTimeSave = 0;

    var currentVideoUrl = '';
    var attemptsLeft = 5;

    function init() {
        renderInterfaceState(currentInterfaceState);

        // handle key strokes for text fields
        document.addEventListener('keyup', onKeyUp);

        // if outside the frame has focus, it will receive the keyboard event via a post message
        window.addEventListener("message", function (e) {
            var msg = JSON.parse(e.data);
            if (typeof msg.keyboardUpEvent !== "undefined") {
                console.log('label frame received keyboard event', msg.keyboardUpEvent);
                onKeyUp(msg.keyboardUpEvent);
            }
        });
        
        realityInterface.addFrameMessageListener(function(message) {
            
            // var sourceFrame = message.sourceFrame;
            var messageFromLOTOSession = message.msgContent.messageFromLOTOSession;
            
            if (typeof messageFromLOTOSession !== 'undefined') {
                
                if (typeof sessionFrameId === 'undefined') {
                    sessionFrameId = message.sourceFrame;
                    saveSessionInfo();
                }
                
                // ensure subsequent messages come from the same session frame that this was first added to
                if (message.sourceFrame === sessionFrameId) {

                    if (typeof messageFromLOTOSession.isEditable !== 'undefined') {
                        isEditable = messageFromLOTOSession.isEditable;
                    }

                    if (typeof messageFromLOTOSession.stepNumber !== 'undefined') {
                        if (stepNumber !== messageFromLOTOSession.stepNumber) {
                            stepNumber = messageFromLOTOSession.stepNumber;
                            saveSessionInfo();
                            renderInterfaceState(currentInterfaceState);
                        }
                    }

                    if (typeof messageFromLOTOSession.hideFrame !== 'undefined') {
                        if (messageFromLOTOSession.hideFrame) {
                            currentInterfaceState = InterfaceStates.HIDDEN;
                            renderInterfaceState(currentInterfaceState);
                        } else {
                            if (currentInterfaceState === InterfaceStates.HIDDEN) {
                                currentInterfaceState = InterfaceStates.COLLAPSED;
                                renderInterfaceState(currentInterfaceState);
                            }
                        }
                    }
                    
                    if (typeof messageFromLOTOSession.expandFrame !== 'undefined') {
                        console.log('LOTO step ' + stepNumber + ' received expand message: ' + messageFromLOTOSession.expandFrame);
                        if (messageFromLOTOSession.expandFrame) {
                            currentInterfaceState = InterfaceStates.EXPANDED_PLAYBACK;
                            renderInterfaceState(currentInterfaceState);
                        } else {
                            if (isCompleted) {
                                currentInterfaceState = InterfaceStates.COMPLETED;
                            } else {
                                currentInterfaceState = InterfaceStates.COLLAPSED;
                            }
                            renderInterfaceState(currentInterfaceState);
                        }
                    }

                    if (typeof messageFromLOTOSession.dangerTypeNumber !== 'undefined') {
                        if (dangerTypeNumber !== messageFromLOTOSession.dangerTypeNumber && messageFromLOTOSession.dangerTypeNumber !== 0) {
                            dangerTypeNumber = messageFromLOTOSession.dangerTypeNumber;
                            saveSessionInfo();
                            renderInterfaceState(currentInterfaceState);
                        }
                    }
                    
                }
            }
        });
        
        realityInterface.addReadListener('complete', function(e) {
            console.log('step ' + stepNumber + ' received value ' + e.value);
            
            if (!isEditable) {
                if (e.value > 0.5) {
                    // mark as completed if not already
                    if (!isCompleted) {
                        isCompleted = true;
                        currentInterfaceState = InterfaceStates.COMPLETED;
                        renderInterfaceState(currentInterfaceState);
                    }
                    
                } else {
                    // mark as incomplete if not already? maybe?
                    if (isCompleted) {
                        isCompleted = false;
                        currentInterfaceState = InterfaceStates.COLLAPSED;
                        renderInterfaceState(currentInterfaceState);
                    }
                }
            }
        });

        realityInterface.addReadPublicDataListener('storage', 'configuration', function (savedConfig) {
            loadConfiguration(savedConfig);
        });

        realityInterface.addReadPublicDataListener('storage', 'sessionInfo', function (savedInfo) {
            loadSessionInfo(savedInfo);
        });
        
        realityInterface.addReadPublicDataListener('storage', 'data', function (videoFilePath) {
            if (typeof videoFilePath !== 'string') { return; }
            videoPath = videoFilePath;
            console.log('read public data');
            attemptToLoadVideo(videoPath, 5);
        });
        
        realityInterface.subscribeToVideoPauseEvents(function(e) {
            if (isVideoPlaying) {
                toggleVideoPlayback();
                console.log('LOTO video was paused because another video was played');
            }
        });

        realityInterface.subscribeToFrameDeletedEvents(function(frameDeletedEvent) {
            if (frameDeletedEvent.frameType === 'loto-session') {
                if (sessionFrameId === frameDeletedEvent.frameId) {

                    // reset all state
                    sessionFrameId = undefined;
                    dangerType = undefined;
                    dangerValue = undefined;
                    stepNumber = 1;
                    dangerTypeNumber = 1;
                    isDangerTypeConfigured = false;
                    isEditable = true;
                    isCompleted = false;
                    
                    // re-render in COLLAPSED state (also updates moveDelay, etc., as a consequence) 
                    currentInterfaceState = InterfaceStates.COLLAPSED;
                    renderInterfaceState(currentInterfaceState);
                }
            }
        });
        
        // add event listeners to divs outside the container
        recordedVideo.addEventListener('pointerdown', toggleVideoPlayback); // play/pause video on tap
        recordedVideo.addEventListener('ended', toggleVideoPlayback); // make sure the state and UI update when it ends

        // add event listeners to video for smart loading/unloading screenshot
        recordedVideo.onloadeddata = function () {
            recordedVideo.currentTime = currentTimeSave;
        };

        recordedVideo.onpause = function () {
            showCanvas();
            hideVideo();
        };

        recordedVideo.onplaying = function (){
            setTimeout(function(){
                recordedVideo.style.display = "inline";
                hideCanvas();
            }, 100);
        };

        document.getElementById('source').addEventListener('error', function(e) {
            console.log('failed to load, show error');
            setTimeout(function() {
                if (attemptsLeft > 0) {
                    console.log('trying again (' + (attemptsLeft-1) + ' attempts left)');
                    attemptToLoadVideo(currentVideoUrl);
                }
            }, 3000);
        });
    }
    init();
    
    function toggleVideoPlayback() {
        
        var videoButton = document.getElementById('videoButton');
        
        if (isVideoPlaying) {
            isVideoPlaying = false;
            recordedVideo.pause();
            
            if (videoButton && videoButton.innerHTML === 'Pause') {
                videoButton.innerHTML = 'Play';
            }
        } else {
            isVideoPlaying = true;
            recordedVideo.play();
            realityInterface.announceVideoPlay();

            if (videoButton && videoButton.innerHTML === 'Play') {
                videoButton.innerHTML = 'Pause';
            }
        }
    }
    
    function onKeyUp(e) {
        console.log('onKeyUp');
        if (currentInterfaceState === InterfaceStates.SET_DANGER_VALUE) {
            var valueTextInput = document.getElementById('dangerValueTextInput');
            if (valueTextInput) {

                var isCharacter = !!e.key.match(/^[a-zA-Z0-9]$/);

                if (isCharacter) {
                    valueTextInput.innerText = valueTextInput.innerText + e.key;
                    
                } else {
                    if (e.key === "Backspace") {
                        text.innerText = text.innerText.slice(0, -1); // remove last character
                    } else if (e.key === " ") {
                        text.innerText = text.innerText + "\u00a0"; // special space character doesn't get escaped
                        resetScroll();
                        setTimeout(function() {
                            resetScroll(); // also do it after a slight delay
                        }, 100);
                    }
                }
                
                dangerValue = valueTextInput.innerText;
            }
        }
    }

    function isFullyConfigured() {
        return isDangerTypeConfigured && isDangerValueConfigured && isEquipmentConfigured;
    }
    
    function expandedState() {
        if (isEditable) {
            return InterfaceStates.EXPANDED_EDITABLE;
        } else {
            return InterfaceStates.EXPANDED_PLAYBACK;
        }
    }
    
    function renderInterfaceState(state) {
        
        console.log('rendering interface state: ' + interfaceStateToString(state));
        
        // remove or hide all previous contents of container
        var first = container.firstElementChild;
        while (first) {
            first.remove();
            first = container.firstElementChild;
        }

        // TODO: add global message listener for stepNumber
        // TODO: add publicData storage system for configurable properties
        var lotoImage = document.createElement('img');
        lotoImage.id = 'lotoImage';
        lotoImage.src = 'resources/loto-icon.svg';
        container.appendChild(lotoImage);

        document.getElementById('videoSrc').classList.add('videoHidden');

        if (state === InterfaceStates.COLLAPSED) {

            if (isFullyConfigured()) {
                lotoImage.remove();
                lotoImage = createDiv('topLeft', 'block', getDangerTypeString() + '-' + (dangerTypeNumber || 0), container);
                lotoImage.style.fontSize = '90px';
                lotoImage.style.fontWeight = 'bold';
                lotoImage.style.borderColor = getDangerTypeColor();
                lotoImage.style.color = getDangerTypeColor();
                lotoImage.id = 'lotoImage';
            }

            lotoImage.addEventListener('pointerdown', function() {
                currentInterfaceState = expandedState();
                renderInterfaceState(currentInterfaceState);
            });

            realityInterface.sendMessageToFrame(sessionFrameId, {
                messageFromLOTOStep: {
                    stepNumber: stepNumber,
                    isCompleted: false
                }
            });
            
        } else {
            
            if (!(state === InterfaceStates.HIDDEN || state === InterfaceStates.COMPLETED)) {

                if (lotoImage) {
                    lotoImage.remove();
                    lotoImage = createDiv('lotoImage', ['block', 'sleek'], 'Done', container);
                }
                
                lotoImage.addEventListener('pointerdown', function() {
                    if (currentInterfaceState === InterfaceStates.EXPANDED_PLAYBACK) {
                        currentInterfaceState = InterfaceStates.COMPLETED;
                    } else {
                        if (currentInterfaceState === InterfaceStates.SET_DANGER_VALUE) {
                            isDangerValueConfigured = dangerValue && dangerValue !== '';
                            saveConfiguration();
                            // if (isFullyConfigured()) {
                            //     currentInterfaceState = InterfaceStates.COLLAPSED;
                            // } else {
                                currentInterfaceState = InterfaceStates.EXPANDED_EDITABLE;
                            // }
                        } else {
                            currentInterfaceState = InterfaceStates.COLLAPSED;
                        }
                    }
                    renderInterfaceState(currentInterfaceState);
                });
            }
            
            if (state === InterfaceStates.EXPANDED_EDITABLE) {

                renderExpanded(true);

                // only record one video for now... todo: ability to overwrite
                if ( /*!videoPath &&*/ !isVideoRecording) {
                    
                    // add a button to record and attach a video to this step
                    var videoButton = createDiv('videoButton', ['block', 'sleek', 'twoLine'], "Attach<br/>Video", container);
                    if (videoPath) {
                        videoButton.innerHTML = 'Replace<br/>Video';
                    }
                    // videoButton.style.lineHeight = '200px';
                    videoButton.style.paddingTop = '50px';
                    videoButton.style.left = '220px';
                    videoButton.style.top = '440px';
                    
                    // var videoRecordIcon = document.createElement('img');
                    // videoRecordIcon.className = 'videoRecordIcon';
                    // videoRecordIcon.src = 'resources/record-button-start.svg';
                    // videoButton.appendChild(videoRecordIcon);

                    // start recording a video when you first tap the button
                    videoButton.addEventListener('pointerdown', function () {
                    // videoRecordIcon.addEventListener('pointerdown', function () {
                        realityInterface.startVideoRecording();
                        isVideoRecording = true;
                        currentInterfaceState = InterfaceStates.RECORDING;
                        renderInterfaceState(currentInterfaceState);
                    });
                }

                /*
                var lockCountDiv = createDiv('lockCount', ['block', 'small', 'sleek'], numLocks + ' L', container);
                lockCountDiv.style.lineHeight = '120px';
                lockCountDiv.style.left = '180px';
                lockCountDiv.style.top = '440px';

                lockCountDiv.addEventListener('pointerdown', function() {
                    currentInterfaceState = InterfaceStates.SET_EQUIPMENT;
                    renderInterfaceState(currentInterfaceState);
                });

                var tagCountDiv = createDiv('tagCount', ['block', 'small', 'sleek'], numTags + ' T', container);
                tagCountDiv.style.lineHeight = '120px';
                tagCountDiv.style.left = '300px';
                tagCountDiv.style.top = '440px';

                tagCountDiv.addEventListener('pointerdown', function() {
                    currentInterfaceState = InterfaceStates.SET_EQUIPMENT;
                    renderInterfaceState(currentInterfaceState);
                });
                */

            } else if (state === InterfaceStates.RECORDING) {

                // add a button to record and attach a video to this step
                var videoButton = createDiv('videoButton', ['block', 'sleek'], null, container);
                videoButton.style.lineHeight = '200px';
                videoButton.style.left = '220px';
                videoButton.style.top = '440px';

                var videoRecordIcon = document.createElement('img');
                videoRecordIcon.className = 'videoRecordIcon';
                videoRecordIcon.src = 'resources/record-button-stop.svg';
                videoButton.appendChild(videoRecordIcon);
                
                if (isVideoRecording) {

                    // stop recording a video when you tap the button again
                    videoRecordIcon.addEventListener('pointerdown', function () {
                        realityInterface.stopVideoRecording(function (videoFilePath) {
                            console.log('video was saved at path: ' + videoFilePath);
                            videoPath = videoFilePath;
                            isVideoRecording = false;
                            renderInterfaceState(currentInterfaceState);
                            realityInterface.writePublicData('storage', 'data', videoFilePath);
                            console.log('stop video recording');
                            attemptToLoadVideo(videoFilePath, 5);
                        });
                        currentInterfaceState = InterfaceStates.EXPANDED_EDITABLE;
                        renderInterfaceState(currentInterfaceState);
                    });
                    
                }
                
                lotoImage.style.display = 'none';

            } else if (state === InterfaceStates.SET_DANGER_TYPE) {
                var water = document.createElement('img');
                water.id = 'water';
                water.className = 'blockSvg';
                water.src = getDangerTypeIconSrc(DangerTypes.WATER);
                water.style.left = 0;
                water.style.top = '220px';
                container.appendChild(water);
                water.addEventListener('pointerdown', function() {
                    setDangerType(DangerTypes.WATER);
                });

                var gas = document.createElement('img');
                gas.id = 'gas';
                gas.className = 'blockSvg';
                gas.src = getDangerTypeIconSrc(DangerTypes.GAS);
                gas.style.left = '220px';
                gas.style.top = '220px';
                container.appendChild(gas);
                gas.addEventListener('pointerdown', function() {
                    setDangerType(DangerTypes.GAS);
                });
                
                var electric = document.createElement('img');
                electric.id = 'electric';
                electric.className = 'blockSvg';
                electric.src = getDangerTypeIconSrc(DangerTypes.ELECTRIC);
                electric.style.left = '440px';
                electric.style.top = '220px';
                container.appendChild(electric);
                electric.addEventListener('pointerdown', function() {
                    setDangerType(DangerTypes.ELECTRIC);
                });

                var pneumatic = document.createElement('img');
                pneumatic.id = 'electric';
                pneumatic.className = 'blockSvg';
                pneumatic.src = getDangerTypeIconSrc(DangerTypes.PNEUMATIC);
                pneumatic.style.left = '660px';
                pneumatic.style.top = '220px';
                container.appendChild(pneumatic);
                pneumatic.addEventListener('pointerdown', function() {
                    setDangerType(DangerTypes.PNEUMATIC);
                });

                function setDangerType(newType) {
                    dangerType = newType;
                    isDangerTypeConfigured = true;
                    saveConfiguration();
                    
                    // send dangerType to session so that it can update step numbers
                    realityInterface.sendMessageToFrame(sessionFrameId, {
                        messageFromLOTOStep: {
                            stepNumber: stepNumber,
                            dangerType: newType
                        }
                    });
                    
                    currentInterfaceState = InterfaceStates.EXPANDED_EDITABLE;
                    renderInterfaceState(currentInterfaceState);
                }

            } else if (state === InterfaceStates.SET_DANGER_VALUE) {
                var textInput = createDiv('dangerValueTextInput', ['block', 'sleek'], (dangerValue || 'enter value...'), container);
                textInput.style.lineHeight = '200px';
                textInput.style.top = '220px';
                textInput.style.width = '420px';
                textInput.setAttribute('contenteditable', 'true');
                textInput.addEventListener('pointerdown', function() {
                    textInput.innerHTML = '';
                    textInput.focus();
                });

                // var submitButton = createDiv('submit', ['block', 'sleek'], '√', container);
                // submitButton.style.lineHeight = '200px';
                // submitButton.style.top = '220px';
                // submitButton.style.left = '440px';
                // submitButton.addEventListener('pointerdown', function() {
                //     isDangerValueConfigured = dangerValue && dangerValue !== '';
                //     currentInterfaceState = InterfaceStates.EXPANDED_EDITABLE;
                //     renderInterfaceState(currentInterfaceState);
                // });

                // addLocator(0, 440);

            } else if (state === InterfaceStates.SET_EQUIPMENT) {
                lockCountDiv = createDiv('lockCount', ['block', 'sleek'], numLocks + ' L', container);
                lockCountDiv.style.lineHeight = '200px';
                lockCountDiv.style.left = '140px';
                lockCountDiv.style.top = '0';

                var lockDecrementDiv = createDiv('lockDecrement', ['block', 'small', 'sleek'], '–', container);
                lockDecrementDiv.style.lineHeight = '120px';
                lockDecrementDiv.style.left = '0';
                lockDecrementDiv.style.top = '40px';
                lockDecrementDiv.addEventListener('pointerdown', function() {
                    numLocks = Math.max(0, numLocks-1);
                    lockCountDiv.innerHTML = numLocks + ' L';
                });

                lockIncrementDiv = createDiv('lockIncrement', ['block', 'small', 'sleek'], '+', container);
                lockIncrementDiv.style.lineHeight = '120px';
                lockIncrementDiv.style.left = '360px';
                lockIncrementDiv.style.top = '40px';
                lockIncrementDiv.addEventListener('pointerdown', function() {
                    numLocks = numLocks+1;
                    lockCountDiv.innerHTML = numLocks + ' L';
                });

                tagCountDiv = createDiv('tagCount', ['block', 'sleek'], numTags + ' T', container);
                tagCountDiv.style.lineHeight = '200px';
                tagCountDiv.style.left = '140px';
                tagCountDiv.style.top = '220px';

                var tagDecrementDiv = createDiv('tagDecrement', ['block', 'small', 'sleek'], '–', container);
                tagDecrementDiv.style.lineHeight = '120px';
                tagDecrementDiv.style.left = '0';
                tagDecrementDiv.style.top = '260px';
                tagDecrementDiv.addEventListener('pointerdown', function() {
                    numTags = Math.max(0, numTags-1);
                    tagCountDiv.innerHTML = numTags + ' T';
                });

                var tagIncrementDiv = createDiv('tagIncrement', ['block', 'small', 'sleek'], '+', container);
                tagIncrementDiv.style.lineHeight = '120px';
                tagIncrementDiv.style.left = '360px';
                tagIncrementDiv.style.top = '260px';
                tagIncrementDiv.addEventListener('pointerdown', function() {
                    numTags = numTags+1;
                    tagCountDiv.innerHTML = numTags + ' T';
                });

                var submitButton = createDiv('submit', ['block', 'sleek'], '√', container);
                submitButton.style.lineHeight = '200px';
                submitButton.style.top = '110px';
                submitButton.style.left = '500px';
                submitButton.addEventListener('pointerdown', function() {
                    isDangerValueConfigured = dangerValue && dangerValue !== '';
                    saveConfiguration();
                    currentInterfaceState = InterfaceStates.EXPANDED_EDITABLE;
                    renderInterfaceState(currentInterfaceState);
                });

                // addLocator(0, 440);

            } else if (state === InterfaceStates.EXPANDED_PLAYBACK) {
                renderExpanded(false);
                
                if (isVideoLoaded) {
                    document.getElementById('videoSrc').classList.remove('videoHidden');

                    // add a button to record and attach a video to this step
                    var videoButton = createDiv('videoButton', ['block', 'sleek'], 'Play', container);
                    videoButton.style.lineHeight = '200px';
                    videoButton.style.left = '220px';
                    videoButton.style.top = '440px';
                    
                    videoButton.addEventListener('pointerdown', toggleVideoPlayback);
                }

                realityInterface.sendMessageToFrame(sessionFrameId, {
                    messageFromLOTOStep: {
                        stepNumber: stepNumber,
                        isCompleted: false
                    }
                });

                registerScreenPositionListenerIfNeeded();

            } else if (state === InterfaceStates.HIDDEN) {
                // hides all interfaces
                lotoImage.style.opacity = 0.3;
                isCompleted = false;
                
            } else if (state === InterfaceStates.COMPLETED) {
                var completedImage = document.createElement('img');
                completedImage.id = 'completedImage';
                completedImage.src = 'resources/completed-icon.svg';
                container.appendChild(completedImage);
                
                completedImage.addEventListener('pointerdown', function() {
                    currentInterfaceState = InterfaceStates.EXPANDED_PLAYBACK;
                    renderInterfaceState(currentInterfaceState);
                });
                
                realityInterface.sendMessageToFrame(sessionFrameId, {
                    messageFromLOTOStep: {
                        stepNumber: stepNumber,
                        isCompleted: true
                    }
                });
                
                lotoImage.style.visibility = 'hidden';
                
                isCompleted = true;
            }
            
            if (state === InterfaceStates.HIDDEN || !isEditable) {
                realityInterface.setMoveDelay(-1); // TODO: listen for session frame deleted events, and undo this (just change state to COLLAPSED)
            } else {
                realityInterface.setMoveDelay(400);
            }
            
            if (state === InterfaceStates.HIDDEN) {
                realityInterface.ignoreAllTouches(true);
            } else {
                realityInterface.ignoreAllTouches(false);
            }
        }
        
        function renderExpanded(shouldAddEventListeners) {
            var dangerTypeDiv = createDiv('topLeft', 'block', getDangerTypeString(), container);
            dangerTypeDiv.style.fontSize = '100px';
            dangerTypeDiv.style.fontWeight = 'bold';
            dangerTypeDiv.style.borderColor = getDangerTypeColor();
            dangerTypeDiv.style.color = getDangerTypeColor();

            var stepNumberDiv = createDiv('topRight', 'block', (dangerTypeNumber || 0), container);
            stepNumberDiv.style.fontSize = '100px';
            stepNumberDiv.style.fontWeight = 'bold';
            stepNumberDiv.style.borderColor = getDangerTypeColor();
            stepNumberDiv.style.color = getDangerTypeColor();
            
            var dangerIconSrc = getDangerTypeIconSrc();
            if (dangerIconSrc) {
                var dangerIconDiv = document.createElement('img');
                dangerIconDiv.id = 'bottomLeft';
                dangerIconDiv.className = 'blockSvg';
                dangerIconDiv.src = getDangerTypeIconSrc();
                container.appendChild(dangerIconDiv);
            } else {
                dangerIconDiv = createDiv('bottomLeft', 'block', null, container);
                dangerIconDiv.style.borderColor = getDangerTypeColor();
                dangerIconDiv.style.color = getDangerTypeColor();
            }


            var dangerValueDiv = createDiv('bottomRight', ['block', 'sleek'], dangerValue || '___', container);
            dangerValueDiv.style.lineHeight = '200px';
            
            if (shouldAddEventListeners) {
                [dangerTypeDiv, dangerIconDiv].forEach(function(div) {
                    div.addEventListener('pointerdown', function() {
                        currentInterfaceState = InterfaceStates.SET_DANGER_TYPE;
                        renderInterfaceState(currentInterfaceState);
                    });
                });
                dangerValueDiv.addEventListener('pointerdown', function() {
                    currentInterfaceState = InterfaceStates.SET_DANGER_VALUE;
                    renderInterfaceState(currentInterfaceState);
                });
            }

        }
        
    }

    function attemptToLoadVideo(videoUrl, newAttemptsLeft) {
        if (typeof videoUrl !== 'string') { return; } // don't try loading in a null or {} path
        
        if (typeof newAttemptsLeft !== 'undefined') {
            attemptsLeft = newAttemptsLeft;
        } else {
            attemptsLeft -= 1;
        }
        
        if (attemptsLeft <= 0) {
            console.log('no more attempts.. failed to load video');
            // TODO: show error UI
            // processStateAction(Action.TIMEOUT);
            // console.warn('timed out trying to load the video... show error');
            return;
        }
        console.log('attempt to load video from url: ' + videoUrl);
        currentVideoUrl = videoUrl;
        
        document.getElementById('source').setAttribute('src', videoUrl);
        recordedVideo.load();
        isVideoLoaded = true;
    }
    
    function saveConfiguration() {
        var configuration = {
            dangerType: dangerType,
            isDangerTypeConfigured: isDangerTypeConfigured,
            dangerValue: dangerValue,
            isDangerValueConfigured: isDangerValueConfigured
        };
        console.log('saveConfiguration', configuration);
        realityInterface.writePublicData('storage', 'configuration',  configuration);
    }
    
    function loadConfiguration(savedConfig) {
        console.log('loadConfiguration', savedConfig);
        dangerType = savedConfig.dangerType;
        isDangerTypeConfigured = savedConfig.isDangerTypeConfigured;
        dangerValue = savedConfig.dangerValue;
        isDangerValueConfigured = savedConfig.isDangerValueConfigured;
        renderInterfaceState(currentInterfaceState);
    }
    
    function saveSessionInfo() {
        var sessionInfo = {
            stepNumber: stepNumber,
            dangerTypeNumber: dangerTypeNumber,
            sessionFrameId: sessionFrameId
        };
        console.log('saveSessionInfo', sessionInfo);
        realityInterface.writePublicData('storage', 'sessionInfo',  sessionInfo);
    }
    
    function loadSessionInfo(savedInfo) {
        console.log('loadSessionInfo', savedInfo);
        stepNumber = savedInfo.stepNumber;
        sessionFrameId = savedInfo.sessionFrameId;
        dangerTypeNumber = savedInfo.dangerTypeNumber;

        setTimeout(function() {
            // TODO: how to make sure sessionInfo is loaded before configuration?
            // send dangerType to session so that it can update step numbers
            realityInterface.sendMessageToFrame(sessionFrameId, {
                messageFromLOTOStep: {
                    stepNumber: stepNumber,
                    dangerType: dangerType
                }
            });
        }, 500);

        renderInterfaceState(currentInterfaceState);
    }

    function registerScreenPositionListenerIfNeeded() {
        if (!isScreenPositionListenerRegistered) {
            isScreenPositionListenerRegistered = true;

            console.log('registed screen position listener for loto step');
            realityInterface.addScreenPositionListener(function(screenPosition) {
                mostRecentScreenPosition = screenPosition;

                var isCurrentStep = (currentInterfaceState === InterfaceStates.EXPANDED_PLAYBACK);
                if (isCurrentStep) {
                    realityInterface.sendMessageToFrame(sessionFrameId, {
                        messageFromLOTOStep: {
                            stepNumber: stepNumber,
                            screenPosition: mostRecentScreenPosition
                        }
                    });
                }
            });
        }
    }
    
    function getDangerTypeString() {
        if (dangerType === DangerTypes.ELECTRIC) {
            return 'E';
        } else if (dangerType === DangerTypes.WATER) {
            return 'W';
        } else if (dangerType === DangerTypes.GAS) {
            return 'P';
        } else if (dangerType === DangerTypes.PNEUMATIC) {
            return 'M';
        }
    }
    
    function getDangerTypeColor(optionalType) {
        var dangerTypeToParse = (typeof optionalType !== 'undefined') ? optionalType : dangerType;
        
        if (dangerTypeToParse === DangerTypes.ELECTRIC) {
            return '#FF007D'; //'rgb(255,0,0)';
        } else if (dangerTypeToParse === DangerTypes.WATER) {
            return '#00FF00'; //'rgb(0,255,0)';
        } else if (dangerTypeToParse === DangerTypes.GAS) {
            return '#75FBFD'; //'rgb(255,0,255)';
        } else if (dangerTypeToParse === DangerTypes.PNEUMATIC) {
            return '#AE00FF'; //'rgb(0,100,255)';
        }
    }
    
    function getDangerTypeIconSrc(optionalType) {
        var dangerTypeToParse = (typeof optionalType !== 'undefined') ? optionalType : dangerType;

        if (dangerTypeToParse === DangerTypes.ELECTRIC) {
            return 'resources/loto-electrical.svg';
        } else if (dangerTypeToParse === DangerTypes.WATER) {
            return 'resources/loto-water.svg';
        } else if (dangerTypeToParse === DangerTypes.GAS) {
            return 'resources/loto-gas.svg';
        } else if (dangerTypeToParse === DangerTypes.PNEUMATIC) {
            return 'resources/loto-mechanical.svg';
        } else return null;
    }
    
    function interfaceStateToString(state) {
        return Object.keys(InterfaceStates)[state]; // this only works because the value of each key was set to be its index
    }

    function showCanvas() {
        if (currentInterfaceState !== InterfaceStates.EXPANDED_PLAYBACK) { return hideCanvas(); }
        console.warn('showCanvas');
        var canvas = document.createElement('canvas');
        canvas.id = 'videoImage';
        document.getElementById('videoSrc').appendChild(canvas);
        var context = canvas.getContext('2d');
        var w = recordedVideo.clientWidth; //recordedVideo.videoWidth;
        var h = recordedVideo.clientHeight; //recordedVideo.videoHeight;

        canvas.width = w;
        canvas.height = h;
        context.fillRect(0, 0, w, h);
        context.drawImage(recordedVideo, 0, 0, w,h);
        // document.getElementById('videoImage').addEventListener('pointerdown', function () {
        //     console.warn('videoImage pressed');
        //     showVideo();
        // });

    }

    function hideCanvas() {
        console.warn('hideCanvas');
        var element = document.getElementById('videoImage');
        if (element) {
            console.warn('hideCanvas 2');
            element.parentNode.removeChild(element);
        }
    }

    function showVideo() {
        if (currentInterfaceState !== InterfaceStates.EXPANDED_PLAYBACK) { return hideVideo(); }

        console.warn('showVideo');
        if (recordedVideo.style.display === "none") {
            console.warn('showVideo 2');
            // recordedVideo.src = videoFilePath;
            document.getElementById('source').setAttribute('src', videoPath);
            recordedVideo.load();
            recordedVideo.currentTime = currentTimeSave;
        }
    }

    function hideVideo() {
        console.warn('hideVideo');
        recordedVideo.pause();
        currentTimeSave = recordedVideo.currentTime;
        // recordedVideo.src = "";
        document.getElementById('source').setAttribute('src', '');
        recordedVideo.style.display = 'none';
    }
    
    /**
     * Shortcut for creating a div with certain style and contents, and possibly adding to a parent element
     * Any parameter can be omitted (pass in null) to ignore those effects
     * @param {string|null} id
     * @param {string|Array.<string>|null} classList
     * @param {string|null} innerHTML
     * @param {HTMLElement|null} parentToAddTo
     * @return {HTMLDivElement}
     */
    function createDiv(id, classList, innerHTML, parentToAddTo) {
        var preExistingDiv = document.getElementById(id);
        var div = preExistingDiv ? preExistingDiv : document.createElement('div');
        if (id) {
            div.id = id;
        }
        if (classList) {
            if (typeof classList === 'string') {
                div.className = classList;
            } else if (typeof classList === 'object') {
                classList.forEach(function(className) {
                    div.classList.add(className);
                });
            }
        }
        if (innerHTML) {
            div.innerHTML = innerHTML;
        }
        if (parentToAddTo) {
            parentToAddTo.appendChild(div);
        }
        return div;
    }
    
</script>
</html>
